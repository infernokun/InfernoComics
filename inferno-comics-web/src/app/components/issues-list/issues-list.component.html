<div class="issues-list">
  <!-- Loading Spinner -->
  <div *ngIf="loading" class="spinner" role="status" aria-label="Loading issues">
    <mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
  </div>

  <!-- Main Content -->
  <ng-container *ngIf="!loading">
    <!-- Toggle Control -->
    <div class="controls-section">
      <div class="control-group">
        <button 
          mat-stroked-button 
          (click)="expandAllSeries()"
          class="control-button"
          aria-label="Expand all series">
          <mat-icon>unfold_more</mat-icon>
          Expand All
        </button>
        <button 
          mat-stroked-button 
          (click)="collapseAllSeries()"
          class="control-button"
          aria-label="Collapse all series">
          <mat-icon>unfold_less</mat-icon>
          Collapse All
        </button>
      </div>
      
      <mat-slide-toggle 
        [(ngModel)]="uploadedPhotos"
        (change)="onToggleChange()"
        color="primary"
        aria-label="Toggle between original and uploaded photos">
        <mat-icon class="toggle-icon">photo_library</mat-icon>
        Show Uploaded Photos
      </mat-slide-toggle>
    </div>

    <!-- Empty State -->
    <div *ngIf="seriesWithIssues.length === 0" class="empty-state" role="status">
      <mat-icon class="empty-icon">library_books</mat-icon>
      <h3>No Series Found</h3>
      <p>There are currently no comic series available.</p>
    </div>

    <!-- Series List -->
    <div 
      *ngFor="let seriesItem of seriesWithIssues; trackBy: trackBySeriesId" 
      class="series-block"
      role="region"
      [attr.aria-label]="seriesItem.series.name + ' series'">
      
      <h2 class="series-title">
        <mat-icon class="series-icon">collections_bookmark</mat-icon>
        {{ seriesItem.series.name }}
        <span class="issue-count" *ngIf="hasIssues(seriesItem)">
          ({{ seriesItem.issues.length }} {{ seriesItem.issues.length === 1 ? 'issue' : 'issues' }})
        </span>
      </h2>

      <!-- Issues Grid -->
      <div *ngIf="hasIssues(seriesItem); else noIssues" class="issues-container">
        <div class="issues-grid">
          <div 
            *ngFor="let issue of getDisplayedIssues(seriesItem); trackBy: trackByIssueId" 
            class="issue-item"
            role="article"
            tabindex="0"
            [attr.aria-label]="'Issue ' + issue.issueNumber + ' of ' + seriesItem.series.name">
            
            <div class="issue-image-wrapper">
              <img 
                [src]="getImageUrl(issue)"
                [alt]="seriesItem.series.name + ' Issue ' + issue.issueNumber + ' cover'"
                (error)="onImageError($event)"
                class="issue-img"
                loading="lazy" />
            </div>

            <div class="issue-info">
              <span class="issue-number" [title]="'Issue Number: ' + issue.issueNumber">
                #{{ issue.issueNumber }}
              </span>
              <span class="issue-id" [title]="'Comic Vine ID: ' + issue.comicVineId">
                ID: {{ issue.comicVineId }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Show More/Less Button -->
        <div *ngIf="hasMoreIssues(seriesItem)" class="show-more-container">
          <button 
            mat-button 
            color="primary"
            (click)="toggleSeriesExpansion(seriesItem.series.id!)"
            class="show-more-button"
            [attr.aria-expanded]="isSeriesExpanded(seriesItem.series.id!)"
            [attr.aria-label]="isSeriesExpanded(seriesItem.series.id!) ? 'Show fewer issues' : 'Show ' + getHiddenIssuesCount(seriesItem) + ' more issues'">
            <mat-icon>{{ isSeriesExpanded(seriesItem.series.id!) ? 'expand_less' : 'expand_more' }}</mat-icon>
            {{ isSeriesExpanded(seriesItem.series.id!) ? 'Show Less' : 'Show ' + getHiddenIssuesCount(seriesItem) + ' More' }}
          </button>
        </div>
      </div>

      <!-- No Issues Template -->
      <ng-template #noIssues>
        <div class="no-issues-msg" role="status">
          <mat-icon>info</mat-icon>
          <span>No issues available for this series.</span>
        </div>
      </ng-template>
    </div>
  </ng-container>
</div>