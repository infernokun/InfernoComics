<div class="admin-wrapper">
  <mat-card class="admin-card">
    <mat-card-header>
      <div class="header-content">
        <div>
          <mat-card-title>Admin Panel</mat-card-title>
          <mat-card-subtitle>Manage system settings and bulk operations</mat-card-subtitle>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group [(selectedIndex)]="selectedTabIndex" animationDuration="300ms">

        <!-- Global Operations Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">build</mat-icon>
            Operations
          </ng-template>

          <div class="tab-content">
            <section class="operations-section">
              <div class="section-header">
                <h3>
                  <mat-icon>sync</mat-icon>
                  Bulk Reverification
                </h3>
              </div>

              <div class="operations-grid">
                <!-- Reverify All Series -->
                <mat-card class="operation-card">
                  <mat-card-header>
                    <mat-icon mat-card-avatar class="operation-icon">library_books</mat-icon>
                    <mat-card-title>Reverify All Series</mat-card-title>
                    <mat-card-subtitle>Update metadata for all series from Comic Vine</mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    <p class="operation-description">
                      This will update series information including publisher, year, description, and cover images
                      for all {{ allSeries.length }} series in your collection.
                    </p>
                    @if (reverifyingAllSeries) {
                      <div class="progress-container">
                        <mat-progress-bar mode="determinate"
                          [value]="(reverifySeriesProgress.current / reverifySeriesProgress.total) * 100">
                        </mat-progress-bar>
                        <span class="progress-text">
                          {{ reverifySeriesProgress.current }} / {{ reverifySeriesProgress.total }}
                        </span>
                      </div>
                    }
                  </mat-card-content>
                  <mat-card-actions>
                    <button mat-raised-button color="primary"
                            (click)="reverifyAllSeries()"
                            [disabled]="reverifyingAllSeries || reverifyingAllIssues || loadingSeries">
                      @if (reverifyingAllSeries) {
                        <mat-spinner diameter="20"></mat-spinner>
                      } @else {
                        <mat-icon>refresh</mat-icon>
                      }
                      Reverify Series
                    </button>
                  </mat-card-actions>
                </mat-card>

                <!-- Reverify All Issues -->
                <mat-card class="operation-card">
                  <mat-card-header>
                    <mat-icon mat-card-avatar class="operation-icon">collections_bookmark</mat-icon>
                    <mat-card-title>Reverify All Issues</mat-card-title>
                    <mat-card-subtitle>Update metadata for all issues from Comic Vine</mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    <p class="operation-description">
                      This will update issue information including cover dates, titles, descriptions, and images
                      for all issues across {{ allSeries.length }} series.
                    </p>
                    @if (reverifyingAllIssues) {
                      <div class="progress-container">
                        <mat-progress-bar mode="determinate"
                          [value]="(reverifyIssuesProgress.current / reverifyIssuesProgress.total) * 100">
                        </mat-progress-bar>
                        <span class="progress-text">
                          Series {{ reverifyIssuesProgress.current }} / {{ reverifyIssuesProgress.total }}
                        </span>
                      </div>
                    }
                  </mat-card-content>
                  <mat-card-actions>
                    <button mat-raised-button color="accent"
                            (click)="reverifyAllIssues()"
                            [disabled]="reverifyingAllSeries || reverifyingAllIssues || loadingSeries">
                      @if (reverifyingAllIssues) {
                        <mat-spinner diameter="20"></mat-spinner>
                      } @else {
                        <mat-icon>sync</mat-icon>
                      }
                      Reverify Issues
                    </button>
                  </mat-card-actions>
                </mat-card>
              </div>
            </section>
          </div>
        </mat-tab>

        <!-- Recognition Configuration Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">settings</mat-icon>
            Recognition
          </ng-template>

          <div class="tab-content">
            @if (configForm) {
              <div class="config-header">
                <div class="config-title">
                  <h3>Recognition Configuration</h3>
                  <p>Customize recognition settings and presets</p>
                </div>
                <div class="config-actions">
                  <mat-chip-set aria-label="Status">
                    <mat-chip [class.unsaved]="hasUnsavedChanges">
                      {{ hasUnsavedChanges ? 'Unsaved Changes' : 'Saved' }}
                    </mat-chip>
                  </mat-chip-set>
                  <button mat-icon-button [matMenuTriggerFor]="menu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="onExport()">
                      <mat-icon>download</mat-icon>
                      <span>Export Config</span>
                    </button>
                    <button mat-menu-item (click)="fileInput.click()">
                      <mat-icon>upload</mat-icon>
                      <span>Import Config</span>
                    </button>
                  </mat-menu>
                  <input #fileInput type="file" accept=".json" (change)="onImport($event)" style="display: none;">
                </div>
              </div>

              <div [formGroup]="configForm">
                <!-- Global settings -->
                <section class="section-global">
                  <div class="section-header">
                    <h3>
                      <mat-icon>settings</mat-icon>
                      Global Settings
                    </h3>
                  </div>
                  <div class="settings-grid">
                    <mat-form-field appearance="outline">
                      <mat-label>Performance Level</mat-label>
                      <mat-select formControlName="performance_level">
                        @for (lvl of performanceLevels; track lvl) {
                          <mat-option [value]="lvl.value">
                            <div class="option-content">
                              <span class="option-label">{{ lvl.label }}</span>
                            </div>
                          </mat-option>
                        }
                      </mat-select>
                      <mat-icon matPrefix>speed</mat-icon>
                      <mat-hint>Choose the performance profile</mat-hint>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                      <mat-label>Result Batch</mat-label>
                      <input matInput type="number" formControlName="result_batch" min="1" />
                      <mat-icon matPrefix>batch_prediction</mat-icon>
                      <mat-hint>Number of results per batch</mat-hint>
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                      <mat-label>Similarity Threshold</mat-label>
                      <input matInput type="text" formControlName="similarity_threshold"
                        placeholder="e.g. 55%" />
                      <mat-icon matPrefix>tune</mat-icon>
                      <mat-hint>Minimum similarity score</mat-hint>
                    </mat-form-field>
                  </div>
                </section>

                <!-- Preset list -->
                <section class="section-presets">
                  <div class="section-header">
                    <h3>
                      <mat-icon>view_module</mat-icon>
                      Presets
                    </h3>
                  </div>
                  <mat-tab-group animationDuration="300ms" [(selectedIndex)]="selectedPresetIndex">
                    @for (presetKey of Object.keys(presetControls); track presetKey; let i = $index) {
                      <mat-tab [label]="presetKey | titlecase">
                        <ng-template mat-tab-label>
                          <mat-icon class="tab-icon">{{ getPresetIcon(presetKey) }}</mat-icon>
                          {{ presetKey | titlecase }}
                        </ng-template>
                        <div class="preset-content" [formGroup]="presetControls[presetKey]">
                          <!-- Detectors -->
                          <mat-expansion-panel class="sub-section-panel" [expanded]="true">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                <mat-icon>visibility</mat-icon>
                                Detectors (Max Features)
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <div formGroupName="detectors" class="param-grid">
                              @for (det of Object.keys(presetControls[presetKey].get('detectors')?.value); track det) {
                                <mat-form-field appearance="outline" class="compact-field">
                                  <mat-label>{{ det | uppercase }}</mat-label>
                                  <input matInput type="number" [formControlName]="det" min="0" />
                                  <mat-icon matPrefix class="small-icon">photo_filter</mat-icon>
                                </mat-form-field>
                              }
                            </div>
                          </mat-expansion-panel>
                          <!-- Feature weights -->
                          <mat-expansion-panel class="sub-section-panel" [expanded]="true">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                <mat-icon>linear_scale</mat-icon>
                                Feature Weights
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <div formGroupName="feature_weights" class="param-grid">
                              @for (ft of Object.keys(presetControls[presetKey].get('feature_weights')?.value); track ft) {
                                <mat-form-field appearance="outline" class="compact-field">
                                  <mat-label>{{ ft | titlecase }}</mat-label>
                                  <input matInput type="number" step="0.01" [formControlName]="ft"
                                    min="0" max="1" />
                                  <mat-icon matPrefix class="small-icon">balance</mat-icon>
                                  <mat-hint>Range: 0.00 - 1.00</mat-hint>
                                </mat-form-field>
                              }
                            </div>
                          </mat-expansion-panel>
                          <!-- Performance Settings -->
                          <mat-expansion-panel class="sub-section-panel" [expanded]="true">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                <mat-icon>tune</mat-icon>
                                Performance Settings
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <div class="settings-row">
                              <mat-form-field appearance="outline">
                                <mat-label>Image Size</mat-label>
                                <input matInput type="number" formControlName="image_size" min="1" />
                                <mat-icon matPrefix>photo_size_select_large</mat-icon>
                                <mat-hint>Processing image dimensions</mat-hint>
                              </mat-form-field>
                              <mat-form-field appearance="outline">
                                <mat-label>Max Workers</mat-label>
                                <input matInput type="number" formControlName="max_workers" min="1" />
                                <mat-icon matPrefix>groups</mat-icon>
                                <mat-hint>Parallel processing threads</mat-hint>
                              </mat-form-field>
                            </div>
                          </mat-expansion-panel>
                          <!-- Options (toggles) -->
                          <mat-expansion-panel class="sub-section-panel options-panel" [expanded]="true">
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                <mat-icon>toggle_on</mat-icon>
                                Processing Options
                              </mat-panel-title>
                            </mat-expansion-panel-header>
                            <div formGroupName="options" class="options-container">
                              <mat-card class="option-card">
                                <mat-slide-toggle formControlName="use_advanced_matching" color="primary">
                                  <div class="toggle-content">
                                    <strong>Advanced Matching</strong>
                                    <span class="toggle-hint">Uses sophisticated algorithms for better accuracy</span>
                                  </div>
                                </mat-slide-toggle>
                              </mat-card>
                              <mat-card class="option-card">
                                <mat-slide-toggle formControlName="use_comic_detection" color="primary">
                                  <div class="toggle-content">
                                    <strong>Comic Detection</strong>
                                    <span class="toggle-hint">Optimized for comic book and manga recognition</span>
                                  </div>
                                </mat-slide-toggle>
                              </mat-card>
                              <mat-card class="option-card">
                                <mat-slide-toggle formControlName="cache_only" color="primary">
                                  <div class="toggle-content">
                                    <strong>Cache Only</strong>
                                    <span class="toggle-hint">Use cached results only (minimal preset)</span>
                                  </div>
                                </mat-slide-toggle>
                              </mat-card>
                            </div>
                          </mat-expansion-panel>
                        </div>
                      </mat-tab>
                    }
                  </mat-tab-group>
                </section>
              </div>

              <div class="action-bar">
                <button mat-button (click)="onCancel()" [disabled]="!hasUnsavedChanges">
                  Cancel
                </button>
                <button mat-raised-button color="primary" (click)="onSave()"
                  [disabled]="configForm.invalid || !hasUnsavedChanges">
                  <mat-icon>save</mat-icon>
                  Save Configuration
                </button>
              </div>
            }
            @if (!configForm) {
              @if (loadingConfig) {
                <div class="loading">
                  <mat-spinner diameter="60"></mat-spinner>
                  <p class="loading-text">Loading configuration...</p>
                </div>
              } @else {
                <div class="loading">
                  <p class="loading-text">Failed to load configuration</p>
                </div>
              }
            }
          </div>
        </mat-tab>

      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
