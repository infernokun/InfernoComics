<!-- series-admin.component.html -->
<div class="admin-container" *ngIf="!loading && series">
  <!-- Header -->
  <div class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <a mat-stroked-button class="back-button" matTooltip="Go Back" color="accent" [routerLink]="['/series', series.id ]">
            <mat-icon>arrow_back</mat-icon>
        </a>
        <h1>
          <mat-icon>admin_panel_settings</mat-icon>
          Series Admin: {{ series.name }}
        </h1>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="reverifyMetadata()">
          <mat-icon>refresh</mat-icon>
          Reverify Metadata
        </button>
        <button mat-stroked-button color="warn" (click)="clearCache()">
          <mat-icon>clear_all</mat-icon>
          Clear Cache
        </button>
      </div>
    </div>
  </div>

  <!-- Basic Information -->
  <mat-card class="admin-section">
    <mat-card-header (click)="toggleSection('basicInfo')" class="clickable-header">
      <mat-card-title>
        <mat-icon>{{ expandedSections.basicInfo ? 'expand_less' : 'expand_more' }}</mat-icon>
        Basic Information
      </mat-card-title>
    </mat-card-header>
    <mat-card-content *ngIf="expandedSections.basicInfo">
      <div class="info-grid">
        <div class="info-item">
          <label>ID:</label>
          <span class="copyable" (click)="copyToClipboard(series.id!.toString())">
            {{ series.id }}
            <mat-icon class="copy-icon">content_copy</mat-icon>
          </span>
        </div>
        <div class="info-item">
          <label>Name:</label>
          <span>{{ series.name }}</span>
        </div>
        <div class="info-item">
          <label>Publisher:</label>
          <span>{{ series.publisher || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <label>Start Year:</label>
          <span>{{ series.startYear || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <label>End Year:</label>
          <span>{{ series.endYear || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <label>Issue Count:</label>
          <span class="badge">{{ series.issuesOwnedCount }} / {{series.issuesAvailableCount}}</span>
        </div>
        <div class="info-item full-width">
          <label>Description:</label>
          <div class="description-container">
            <p>{{ series.description || 'No description available' }}</p>
            <span class="description-flag" *ngIf="series.generatedDescription">
              <mat-icon>auto_awesome</mat-icon>
              AI Generated
            </span>
          </div>
        </div>
        <div class="info-item full-width" *ngIf="series.imageUrl">
          <label>Cover Image:</label>
          <div class="image-container">
            <img [src]="series.imageUrl" [alt]="series.name" (click)="openImageInNewTab(series.imageUrl)">
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Comic Vine Integration -->
  <mat-card class="admin-section">
    <mat-card-header (click)="toggleSection('comicVine')" class="clickable-header">
      <mat-card-title>
        <mat-icon>{{ expandedSections.comicVine ? 'expand_less' : 'expand_more' }}</mat-icon>
        Comic Vine Integration
      </mat-card-title>
    </mat-card-header>
    <mat-card-content *ngIf="expandedSections.comicVine">
      <div class="info-grid">
        <div class="info-item">
          <label>Primary Comic Vine ID:</label>
          <span class="copyable" *ngIf="series.comicVineId" (click)="copyToClipboard(series.comicVineId)">
            {{ series.comicVineId }}
            <mat-icon class="copy-icon">content_copy</mat-icon>
          </span>
          <span *ngIf="!series.comicVineId">N/A</span>
        </div>
        <div class="info-item full-width">
          <label>All Comic Vine IDs:</label>
          <div class="id-list" *ngIf="series.comicVineIds && series.comicVineIds.length > 0">
            <mat-chip-listbox>
              <mat-chip-option *ngFor="let id of series.comicVineIds" 
                               (click)="copyToClipboard(id)"
                               class="id-chip">
                {{ id }}
              </mat-chip-option>
            </mat-chip-listbox>
          </div>
          <span *ngIf="!series.comicVineIds || series.comicVineIds.length === 0">No Comic Vine IDs</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- GCD Integration -->
  <mat-card class="admin-section">
    <mat-card-header (click)="toggleSection('gcd')" class="clickable-header">
      <mat-card-title>
        <mat-icon>{{ expandedSections.gcd ? 'expand_less' : 'expand_more' }}</mat-icon>
        GCD Integration
      </mat-card-title>
    </mat-card-header>
    <mat-card-content *ngIf="expandedSections.gcd">
      <div class="info-grid">
        <div class="info-item full-width">
          <label>GCD IDs:</label>
          <div class="id-list" *ngIf="series.gcdIds && series.gcdIds.length > 0">
            <mat-chip-listbox>
              <mat-chip-option *ngFor="let id of series.gcdIds" 
                               (click)="copyToClipboard(id)"
                               class="id-chip gcd-chip">
                {{ id }}
              </mat-chip-option>
            </mat-chip-listbox>
          </div>
          <span *ngIf="!series.gcdIds || series.gcdIds.length === 0">No GCD IDs</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Cache Information -->
  <mat-card class="admin-section">
    <mat-card-header (click)="toggleSection('cache')" class="clickable-header">
      <mat-card-title>
        <mat-icon>{{ expandedSections.cache ? 'expand_less' : 'expand_more' }}</mat-icon>
        Cache Information
      </mat-card-title>
    </mat-card-header>
    <mat-card-content *ngIf="expandedSections.cache">
      <div class="info-grid">
        <div class="info-item">
          <label>Last Cached:</label>
          <span>{{ formatDate(series.lastCachedCovers!) }}</span>
        </div>
        <div class="info-item">
          <label>Cached Covers Count:</label>
          <span class="badge">{{ series.cachedCoverUrls?.length || 0 }}</span>
        </div>
      </div>
      
      <div class="cached-covers" *ngIf="series.cachedCoverUrls && series.cachedCoverUrls.length > 0">
        <h4>Cached Cover URLs</h4>
        <div class="covers-grid">
          <mat-card *ngFor="let cover of series.cachedCoverUrls; let i = index" class="cover-card">
            <mat-card-header>
              <mat-card-title>{{ cover.name || 'Untitled' }}</mat-card-title>
              <mat-card-subtitle>Issue #{{ cover.issueNumber || 'N/A' }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="cover-info">
                <div class="cover-detail">
                  <label>Comic Vine ID:</label>
                  <span class="copyable" (click)="copyToClipboard(cover.comicVineId!)">
                    {{ cover.comicVineId }}
                  </span>
                </div>
                <div class="cover-detail" *ngIf="cover.parentComicVineId">
                  <label>Parent ID:</label>
                  <span class="copyable" (click)="copyToClipboard(cover.parentComicVineId)">
                    {{ cover.parentComicVineId }}
                  </span>
                </div>
                <div class="cover-detail">
                  <label>Cover Images ({{ cover.urls?.length || 0 }}):</label>
                  
                  <!-- Single image - show directly -->
                  <div *ngIf="cover.urls && cover.urls.length === 1" class="single-image">
                    <img [src]="cover.urls[0]" 
                         [alt]="cover.name + ' Issue ' + cover.issueNumber"
                         (click)="openImageInNewTab(cover.urls[0])"
                         class="cover-thumbnail">
                  </div>
                  
                  <!-- Multiple images - show thumbnails with toggle -->
                  <div *ngIf="cover.urls && cover.urls.length > 1" class="multiple-images">
                    <div class="image-grid" [class.expanded]="cover.showAllImages">
                      <img *ngFor="let url of (cover.showAllImages ? cover.urls : cover.urls.slice(0, 3))" 
                           [src]="url" 
                           [alt]="cover.name + ' Issue ' + cover.issueNumber"
                           (click)="openImageInNewTab(url)"
                           class="cover-thumbnail">
                    </div>
                    
                    <button *ngIf="cover.urls.length > 3" 
                            mat-text-button 
                            (click)="cover.showAllImages = !cover.showAllImages"
                            class="toggle-images-btn">
                      <mat-icon>{{ cover.showAllImages ? 'expand_less' : 'expand_more' }}</mat-icon>
                      {{ cover.showAllImages ? 'Show Less' : 'Show All (' + cover.urls.length + ')' }}
                    </button>
                  </div>
                  
                  <!-- No images -->
                  <div *ngIf="!cover.urls || cover.urls.length === 0" class="no-images">
                    <mat-icon>image_not_supported</mat-icon>
                    <span>No images available</span>
                  </div>
                </div>
                <div class="cover-detail" *ngIf="cover.error">
                  <label>Error:</label>
                  <span class="error-text">{{ cover.error }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Issues -->
  <mat-card class="admin-section">
    <mat-card-header (click)="toggleSection('issues')" class="clickable-header">
      <mat-card-title>
        <mat-icon>{{ expandedSections.issues ? 'expand_less' : 'expand_more' }}</mat-icon>
        Issues ({{ series.issues?.length || 0 }})
      </mat-card-title>
    </mat-card-header>
    <mat-card-content *ngIf="expandedSections.issues">
      <div class="issues-container" *ngIf="series.issues && series.issues.length > 0">
        <mat-accordion>
          <mat-expansion-panel *ngFor="let issue of series.issues; let i = index">
            <mat-expansion-panel-header>
              <mat-panel-title>
                Issue #{{ issue.issueNumber }}
                <span class="issue-flags">
                  <mat-chip *ngIf="issue.keyIssue" class="key-issue-chip">KEY</mat-chip>
                  <mat-chip *ngIf="issue.variant" class="variant-chip">VARIANT</mat-chip>
                </span>
              </mat-panel-title>
              <mat-panel-description>
                {{ issue.title || 'Untitled' }}
                <span *ngIf="issue.condition" 
                      class="condition-badge"
                      [style.background-color]="getConditionColor(issue.condition)">
                  {{ issue.condition }}
                </span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="issue-details">
              <div class="issue-grid">
                <div class="issue-item">
                  <label>ID:</label>
                  <span class="copyable" (click)="copyToClipboard(issue.id!.toString())">
                    {{ issue.id }}
                  </span>
                </div>
                <div class="issue-item">
                  <label>Title:</label>
                  <span>{{ issue.title || 'N/A' }}</span>
                </div>
                <div class="issue-item">
                  <label>Cover Date:</label>
                  <span>{{ issue.coverDate || 'N/A' }}</span>
                </div>
                <div class="issue-item">
                  <label>Purchase Date:</label>
                  <span>{{ issue.purchaseDate || 'N/A' }}</span>
                </div>
                <div class="issue-item">
                  <label>Purchase Price:</label>
                  <span>{{ formatCurrency(issue.purchasePrice!) }}</span>
                </div>
                <div class="issue-item">
                  <label>Current Value:</label>
                  <span>{{ formatCurrency(issue.currentValue!) }}</span>
                </div>
                <div class="issue-item">
                  <label>Comic Vine ID:</label>
                  <span class="copyable" *ngIf="issue.comicVineId" (click)="copyToClipboard(issue.comicVineId)">
                    {{ issue.comicVineId }}
                  </span>
                  <span *ngIf="!issue.comicVineId">N/A</span>
                </div>
                <div class="issue-item full-width" *ngIf="issue.description">
                  <label>Description:</label>
                  <p>{{ issue.description }}</p>
                  <span class="description-flag" *ngIf="issue.generatedDescription">
                    <mat-icon>auto_awesome</mat-icon>
                    AI Generated
                  </span>
                </div>
                <div class="issue-item full-width" *ngIf="issue.notes">
                  <label>Notes:</label>
                  <p>{{ issue.notes }}</p>
                </div>
                <div class="issue-item full-width" *ngIf="issue.gcdIds && issue.gcdIds.length > 0">
                  <label>GCD IDs:</label>
                  <mat-chip-listbox>
                    <mat-chip-option *ngFor="let gcdId of issue.gcdIds" 
                                     (click)="copyToClipboard(gcdId)"
                                     class="id-chip gcd-chip">
                      {{ gcdId }}
                    </mat-chip-option>
                  </mat-chip-listbox>
                </div>
              </div>

              <div class="issue-images" *ngIf="issue.imageUrl || issue.uploadedImageUrl">
                <h5>Images</h5>
                <div class="image-row">
                  <div *ngIf="issue.imageUrl" class="image-container">
                    <label>Cover Image:</label>
                    <img [src]="issue.imageUrl" [alt]="'Issue ' + issue.issueNumber" 
                         (click)="openImageInNewTab(issue.imageUrl)">
                  </div>
                  <div *ngIf="issue.uploadedImageUrl" class="image-container">
                    <label>Uploaded Image:</label>
                    <img [src]="issue.uploadedImageUrl" [alt]="'Issue ' + issue.issueNumber + ' uploaded'" 
                         (click)="openImageInNewTab(issue.uploadedImageUrl)">
                  </div>
                </div>
              </div>

              <div class="variant-covers" *ngIf="issue.variantCovers && issue.variantCovers.length > 0">
                <h5>Variant Covers ({{ issue.variantCovers.length }})</h5>
                <div class="variants-grid">
                  <mat-card *ngFor="let variant of issue.variantCovers" class="variant-card">
                    <mat-card-content>
                      <div class="variant-info">
                        <div><label>ID:</label> {{ variant.id }}</div>
                        <div><label>Caption:</label> {{ variant.caption || 'N/A' }}</div>
                        <div><label>Tags:</label> {{ variant.imageTags || 'N/A' }}</div>
                        <div *ngIf="variant.originalUrl">
                          <a [href]="variant.originalUrl" target="_blank" class="url-link">
                            <mat-icon>image</mat-icon>
                            View Variant
                          </a>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      <div *ngIf="!series.issues || series.issues.length === 0" class="no-data">
        No issues found for this series.
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Timestamps -->
  <mat-card class="admin-section">
    <mat-card-header (click)="toggleSection('timestamps')" class="clickable-header">
      <mat-card-title>
        <mat-icon>{{ expandedSections.timestamps ? 'expand_less' : 'expand_more' }}</mat-icon>
        Timestamps
      </mat-card-title>
    </mat-card-header>
    <mat-card-content *ngIf="expandedSections.timestamps">
      <div class="info-grid">
        <div class="info-item">
          <label>Created At:</label>
          <span>{{ formatDate(series.createdAt!) }}</span>
        </div>
        <div class="info-item">
          <label>Updated At:</label>
          <span>{{ formatDate(series.updatedAt!) }}</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <mat-spinner></mat-spinner>
  <p>Loading series data...</p>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="error && !loading">
  <mat-icon color="warn">error</mat-icon>
  <h2>{{ error }}</h2>
  <button mat-raised-button color="primary" (click)="loadSeries()">
    <mat-icon>refresh</mat-icon>
    Retry
  </button>
</div>