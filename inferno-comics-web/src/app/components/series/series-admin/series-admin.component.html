@if (!loading && series) {
  <div class="admin-container">
    <div class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <a mat-stroked-button class="back-button" matTooltip="Go Back" color="accent" [routerLink]="['/series', series.slug ]">
            <mat-icon>arrow_back</mat-icon>
          </a>
          <h1>
            <mat-icon>admin_panel_settings</mat-icon>
            {{ series.name }}
          </h1>
        </div>
        <div class="header-actions">
          <button mat-raised-button color="primary" (click)="reverifyMetadata()">
            <mat-icon>refresh</mat-icon>
            Reverify Metadata
          </button>
          <button mat-raised-button color="accent" (click)="reverifyIssues()" [disabled]="reverifyingIssues">
            @if (reverifyingIssues) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              <mat-icon>sync</mat-icon>
            }
            Reverify Issues
          </button>
          <button mat-stroked-button color="warn" (click)="clearCache()">
            <mat-icon>clear_all</mat-icon>
            Clear Cache
          </button>
        </div>
      </div>
    </div>
    <mat-card class="admin-section">
      <mat-card-header (click)="toggleSection('basicInfo')" class="clickable-header">
        <mat-card-title>
          <mat-icon>{{ expandedSections.basicInfo ? 'expand_less' : 'expand_more' }}</mat-icon>
          Basic Information
        </mat-card-title>
      </mat-card-header>
      @if (expandedSections.basicInfo) {
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>ID:</label>
              <span class="copyable" (click)="copyToClipboard(series.id!.toString())">
                {{ series.id }}
                <mat-icon class="copy-icon">content_copy</mat-icon>
              </span>
            </div>
            <div class="info-item">
              <label>Name:</label>
              <span>{{ series.name }}</span>
            </div>
            <div class="info-item">
              <label>Publisher:</label>
              <span>{{ series.publisher || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Start Year:</label>
              <span>{{ series.startYear || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>End Year:</label>
              <span>{{ series.endYear || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Issue Count:</label>
              <span class="badge">{{ series.issuesOwnedCount }} / {{series.issuesAvailableCount}}</span>
            </div>
            <div class="info-item full-width">
              <label>Description:</label>
              <div class="description-container">
                <p>{{ series.description || 'No description available' }}</p>
                @if (series.generatedDescription) {
                  <span class="description-flag">
                    <mat-icon>auto_awesome</mat-icon>
                    AI Generated
                  </span>
                }
              </div>
            </div>
            @if (series.imageUrl) {
              <div class="info-item full-width">
                <label>Cover Image:</label>
                <div class="image-container">
                  <img [src]="series.imageUrl" [alt]="series.name" (click)="openImageInNewTab(series.imageUrl)">
                </div>
              </div>
            }
          </div>
        </mat-card-content>
      }
    </mat-card>
    <mat-card class="admin-section">
      <mat-card-header (click)="toggleSection('comicVine')" class="clickable-header">
        <mat-card-title>
          <mat-icon>{{ expandedSections.comicVine ? 'expand_less' : 'expand_more' }}</mat-icon>
          Comic Vine Integration
        </mat-card-title>
      </mat-card-header>
      @if (expandedSections.comicVine) {
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Primary Comic Vine ID:</label>
              @if (series.comicVineId) {
                <span class="copyable" (click)="copyToClipboard(series.comicVineId)">
                  {{ series.comicVineId }}
                  <mat-icon class="copy-icon">content_copy</mat-icon>
                </span>
              }
              @if (!series.comicVineId) {
                <span>N/A</span>
              }
            </div>
            <div class="info-item full-width">
              <label>All Comic Vine IDs:</label>
              @if (series.comicVineIds && series.comicVineIds.length > 0) {
                <div class="id-list">
                  <mat-chip-listbox>
                    @for (id of series.comicVineIds; track id) {
                      <mat-chip-option
                        (click)="copyToClipboard(id)"
                        class="id-chip">
                        {{ id }}
                      </mat-chip-option>
                    }
                  </mat-chip-listbox>
                </div>
              }
              @if (!series.comicVineIds || series.comicVineIds.length === 0) {
                <span>No Comic Vine IDs</span>
              }
            </div>
          </div>
        </mat-card-content>
      }
    </mat-card>
    <mat-card class="admin-section">
      <mat-card-header (click)="toggleSection('gcd')" class="clickable-header">
        <mat-card-title>
          <mat-icon>{{ expandedSections.gcd ? 'expand_less' : 'expand_more' }}</mat-icon>
          GCD Integration
        </mat-card-title>
      </mat-card-header>
      @if (expandedSections.gcd) {
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item full-width">
              <label>GCD IDs:</label>
              @if (series.gcdIds && series.gcdIds.length > 0) {
                <div class="id-list">
                  <mat-chip-listbox>
                    @for (id of series.gcdIds; track id) {
                      <mat-chip-option
                        (click)="copyToClipboard(id)"
                        class="id-chip gcd-chip">
                        {{ id }}
                      </mat-chip-option>
                    }
                  </mat-chip-listbox>
                </div>
              }
              @if (!series.gcdIds || series.gcdIds.length === 0) {
                <span>No GCD IDs</span>
              }
            </div>
          </div>
        </mat-card-content>
      }
    </mat-card>
    <mat-card class="admin-section">
      <mat-card-header (click)="toggleSection('cache')" class="clickable-header">
        <mat-card-title>
          <mat-icon>{{ expandedSections.cache ? 'expand_less' : 'expand_more' }}</mat-icon>
          Cache Information
        </mat-card-title>
      </mat-card-header>
      @if (expandedSections.cache) {
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Last Cached:</label>
              <span>{{ formatDate(series.lastCachedCovers!) }}</span>
            </div>
            <div class="info-item">
              <label>Cached Covers Count:</label>
              <span class="badge">{{ series.cachedCoverUrls?.length || 0 }}</span>
            </div>
          </div>
          @if (series.cachedCoverUrls && series.cachedCoverUrls.length > 0) {
            <div class="cached-covers">
              <h4>Cached Cover URLs</h4>
              <div class="covers-grid">
                @for (cover of series.cachedCoverUrls; track cover; let i = $index) {
                  <mat-card class="cover-card">
                    <mat-card-header>
                      <mat-card-title>{{ cover.name || 'Untitled' }}</mat-card-title>
                      <mat-card-subtitle>Issue #{{ cover.issueNumber || 'N/A' }}</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                      <div class="cover-info">
                        <div class="cover-detail">
                          <label>Comic Vine ID:</label>
                          <span class="copyable" (click)="copyToClipboard(cover.comicVineId!)">
                            {{ cover.comicVineId }}
                          </span>
                        </div>
                        @if (cover.parentComicVineId) {
                          <div class="cover-detail">
                            <label>Parent ID:</label>
                            <span class="copyable" (click)="copyToClipboard(cover.parentComicVineId)">
                              {{ cover.parentComicVineId }}
                            </span>
                          </div>
                        }
                        <div class="cover-detail">
                          <label>Cover Images ({{ cover.urls?.length || 0 }}):</label>
                          <!-- Single image - show directly -->
                          @if (cover.urls && cover.urls.length === 1) {
                            <div class="single-image">
                              <img [src]="cover.urls[0]"
                                [alt]="cover.name + ' Issue ' + cover.issueNumber"
                                (click)="openImageInNewTab(cover.urls[0])"
                                class="cover-thumbnail">
                            </div>
                          }
                          <!-- Multiple images - show thumbnails with toggle -->
                          @if (cover.urls && cover.urls.length > 1) {
                            <div class="multiple-images">
                              <div class="image-grid" [class.expanded]="cover.showAllImages">
                                @for (url of (cover.showAllImages ? cover.urls : cover.urls.slice(0, 3)); track url) {
                                  <img
                                    [src]="url"
                                    [alt]="cover.name + ' Issue ' + cover.issueNumber"
                                    (click)="openImageInNewTab(url)"
                                    class="cover-thumbnail">
                                }
                              </div>
                              @if (cover.urls.length > 3) {
                                <button
                                  mat-text-button
                                  (click)="cover.showAllImages = !cover.showAllImages"
                                  class="toggle-images-btn">
                                  <mat-icon>{{ cover.showAllImages ? 'expand_less' : 'expand_more' }}</mat-icon>
                                  {{ cover.showAllImages ? 'Show Less' : 'Show All (' + cover.urls.length + ')' }}
                                </button>
                              }
                            </div>
                          }
                          <!-- No images -->
                          @if (!cover.urls || cover.urls.length === 0) {
                            <div class="no-images">
                              <mat-icon>image_not_supported</mat-icon>
                              <span>No images available</span>
                            </div>
                          }
                        </div>
                        @if (cover.error) {
                          <div class="cover-detail">
                            <label>Error:</label>
                            <span class="error-text">{{ cover.error }}</span>
                          </div>
                        }
                      </div>
                    </mat-card-content>
                  </mat-card>
                }
              </div>
            </div>
          }
        </mat-card-content>
      }
    </mat-card>
    <mat-card class="admin-section">
      <mat-card-header (click)="toggleSection('issues')" class="clickable-header">
        <mat-card-title>
          <mat-icon>{{ expandedSections.issues ? 'expand_less' : 'expand_more' }}</mat-icon>
          Issues ({{ series.issues?.length || 0 }})
        </mat-card-title>
      </mat-card-header>
      @if (expandedSections.issues) {
        <mat-card-content>
          @if (series.issues && series.issues.length > 0) {
            <div class="issues-container">
              <mat-accordion>
                @for (issue of series.issues; track issue; let i = $index) {
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        Issue #{{ issue.issueNumber }}
                        <span class="issue-flags">
                          @if (issue.keyIssue) {
                            <mat-chip class="key-issue-chip">KEY</mat-chip>
                          }
                          @if (issue.variant) {
                            <mat-chip class="variant-chip">VARIANT</mat-chip>
                          }
                        </span>
                      </mat-panel-title>
                      <mat-panel-description>
                        {{ issue.title || 'Untitled' }}
                        @if (issue.condition) {
                          <span
                            class="condition-badge"
                            [style.background-color]="getConditionColor(issue.condition)">
                            {{ issue.condition }}
                          </span>
                        }
                      </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="issue-details">
                      <div class="issue-grid">
                        <div class="issue-item">
                          <label>ID:</label>
                          <span class="copyable" (click)="copyToClipboard(issue.id!.toString())">
                            {{ issue.id }}
                          </span>
                        </div>
                        <div class="issue-item">
                          <label>Title:</label>
                          <span>{{ issue.title || 'N/A' }}</span>
                        </div>
                        <div class="issue-item">
                          <label>Cover Date:</label>
                          <span>{{ issue.coverDate || 'N/A' }}</span>
                        </div>
                        <div class="issue-item">
                          <label>Purchase Date:</label>
                          <span>{{ issue.purchaseDate || 'N/A' }}</span>
                        </div>
                        <div class="issue-item">
                          <label>Purchase Price:</label>
                          <span>{{ formatCurrency(issue.purchasePrice!) }}</span>
                        </div>
                        <div class="issue-item">
                          <label>Current Value:</label>
                          <span>{{ formatCurrency(issue.currentValue!) }}</span>
                        </div>
                        <div class="issue-item">
                          <label>Comic Vine ID:</label>
                          @if (issue.comicVineId) {
                            <span class="copyable" (click)="copyToClipboard(issue.comicVineId)">
                              {{ issue.comicVineId }}
                            </span>
                          }
                          @if (!issue.comicVineId) {
                            <span>N/A</span>
                          }
                        </div>
                        @if (issue.description) {
                          <div class="issue-item full-width">
                            <label>Description:</label>
                            <p>{{ issue.description }}</p>
                            @if (issue.generatedDescription) {
                              <span class="description-flag">
                                <mat-icon>auto_awesome</mat-icon>
                                AI Generated
                              </span>
                            }
                          </div>
                        }
                        @if (issue.notes) {
                          <div class="issue-item full-width">
                            <label>Notes:</label>
                            <p>{{ issue.notes }}</p>
                          </div>
                        }
                        @if (issue.gcdIds && issue.gcdIds.length > 0) {
                          <div class="issue-item full-width">
                            <label>GCD IDs:</label>
                            <mat-chip-listbox>
                              @for (gcdId of issue.gcdIds; track gcdId) {
                                <mat-chip-option
                                  (click)="copyToClipboard(gcdId)"
                                  class="id-chip gcd-chip">
                                  {{ gcdId }}
                                </mat-chip-option>
                              }
                            </mat-chip-listbox>
                          </div>
                        }
                      </div>
                      @if (issue.imageUrl || issue.uploadedImageUrl) {
                        <div class="issue-images">
                          <h5>Images</h5>
                          <div class="image-row">
                            @if (issue.imageUrl) {
                              <div class="image-container">
                                <label>Cover Image:</label>
                                <img [src]="issue.imageUrl" [alt]="'Issue ' + issue.issueNumber"
                                  (click)="openImageInNewTab(issue.imageUrl)">
                              </div>
                            }
                            @if (issue.uploadedImageUrl) {
                              <div class="image-container">
                                <label>Uploaded Image:</label>
                                <img [src]="getImageUrl(issue)" [alt]="'Issue ' + issue.issueNumber + ' uploaded'"
                                  (click)="openImageInNewTab(getImageUrl(issue))">
                              </div>
                            }
                          </div>
                        </div>
                      }
                      @if (issue.variantCovers && issue.variantCovers.length > 0) {
                        <div class="variant-covers">
                          <h5>Variant Covers ({{ issue.variantCovers.length }})</h5>
                          <div class="variants-grid">
                            @for (variant of issue.variantCovers; track variant) {
                              <mat-card class="variant-card">
                                <mat-card-content>
                                  <div class="variant-info">
                                    <div><label>ID:</label> {{ variant.id }}</div>
                                    <div><label>Caption:</label> {{ variant.caption || 'N/A' }}</div>
                                    <div><label>Tags:</label> {{ variant.imageTags || 'N/A' }}</div>
                                    @if (variant.originalUrl) {
                                      <div>
                                        <a [href]="variant.originalUrl" target="_blank" class="url-link">
                                          <mat-icon>image</mat-icon>
                                          View Variant
                                        </a>
                                      </div>
                                    }
                                  </div>
                                </mat-card-content>
                              </mat-card>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </mat-expansion-panel>
                }
              </mat-accordion>
            </div>
          }
          @if (!series.issues || series.issues.length === 0) {
            <div class="no-data">
              No issues found for this series.
            </div>
          }
        </mat-card-content>
      }
    </mat-card>
    <mat-card class="admin-section">
      <mat-card-header (click)="toggleSection('timestamps')" class="clickable-header">
        <mat-card-title>
          <mat-icon>{{ expandedSections.timestamps ? 'expand_less' : 'expand_more' }}</mat-icon>
          Timestamps
        </mat-card-title>
      </mat-card-header>
      @if (expandedSections.timestamps) {
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Created At:</label>
              <span>{{ DateUtils.formatDateTime(series.createdAt!) }}</span>
            </div>
            <div class="info-item">
              <label>Updated At:</label>
              <span>{{ DateUtils.formatDateTime(series.updatedAt!) }}</span>
            </div>
          </div>
        </mat-card-content>
      }
    </mat-card>
  </div>
}

@if (loading) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading series data...</p>
  </div>
}

@if (error && !loading) {
  <div class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <h2>{{ error }}</h2>
    <button mat-raised-button color="primary" (click)="loadSeries()">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>
}