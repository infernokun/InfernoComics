<div class="series-form-container">

  <mat-card>

    <mat-card-header>
      <mat-card-title>
        {{ getFormTitle() }}
      </mat-card-title>
      @if (isComicVineManagementMode) {
        <mat-card-subtitle>
          Add or remove Comic Vine series associations for "{{ seriesForm.get('name')?.value }}"
        </mat-card-subtitle>
      }
    </mat-card-header>

    <mat-card-content>
      <!-- Current Comic Vine Series (Management Mode) -->
      @if (isComicVineManagementMode && existingComicVineData.length > 0) {
        <div class="current-comic-vine-series">
          <h4>Current Comic Vine Series ({{ existingComicVineData.length }})</h4>
          <div class="existing-series-grid">
            @for (series of existingComicVineData; track series) {
              <mat-card class="existing-series-card">
                <div class="series-header">
                  @if (series.imageUrl) {
                    <img [src]="series.imageUrl" [alt]="series.name" class="series-thumbnail">
                  }
                  <div class="series-info">
                    <h5>{{ series.name }}</h5>
                    <p>{{ series.publisher }}</p>
                    @if (series.startYear) {
                      <span>{{ series.startYear }}</span>
                    }
                    @if (series.issueCount) {
                      <span class="issue-count">({{ series.issueCount }} issues)</span>
                    }
                  </div>
                  <button mat-icon-button color="warn"
                    (click)="removeExistingComicVineSeries(series.id)"
                    matTooltip="Remove this series">
                    <mat-icon>remove_circle</mat-icon>
                  </button>
                </div>
              </mat-card>
            }
          </div>
        </div>
      }

      <!-- No existing series message -->
      @if (isComicVineManagementMode && existingComicVineData.length === 0 && !loading) {
        <div class="no-existing-series">
          <mat-icon>info</mat-icon>
          <h4>No Comic Vine Series Currently Associated</h4>
          <p>Search below to add Comic Vine series to this collection.</p>
        </div>
      }

      <form [formGroup]="seriesForm" (ngSubmit)="onSubmit()">
        <div>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Series Name</mat-label>
              <input matInput formControlName="name" required>
              @if (seriesForm.get('name')?.hasError('required')) {
                <mat-error>
                  Series name is required
                </mat-error>
              }
              @if (seriesForm.get('name')?.hasError('maxlength')) {
                <mat-error>
                  Series name must not exceed 255 characters
                </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Issues Available</mat-label>
              <input matInput type="number" formControlName="issuesAvailableCount">
              @if (seriesForm.get('issuesAvailableCount')?.value) {
                <mat-hint>
                  {{ seriesForm.get('issuesAvailableCount')?.value }} issues available
                </mat-hint>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Issues Owned</mat-label>
              <input matInput type="number" formControlName="issuesOwnedCount">
              @if (seriesForm.get('issuesOwnedCount')?.value) {
                <mat-hint>
                  {{ seriesForm.get('issuesOwnedCount')?.value }} issues in collection
                </mat-hint>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Publisher</mat-label>
              <input matInput formControlName="publisher">
            </mat-form-field>

            <mat-form-field appearance="outline" class="quarter-width">
              <mat-label>Start Year</mat-label>
              <input matInput type="number" formControlName="startYear">
            </mat-form-field>

            <mat-form-field appearance="outline" class="quarter-width">
              <mat-label>End Year</mat-label>
              <input matInput type="number" formControlName="endYear">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="4" maxlength="10000"></textarea>
              <mat-hint align="end">
                {{ seriesForm.get('description')?.value?.length || 0 }}/10000
              </mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Image URL</mat-label>
              <input matInput formControlName="imageUrl">
            </mat-form-field>
          </div>
        </div>

        <!-- Comic Vine Search -->
        <div class="comic-vine-search">
          @if (isComicVineManagementMode) {
            <h4>Add New Comic Vine Series</h4>
          }

          <!-- Custom search input -->
          <div class="search-input-section">
            <mat-form-field appearance="outline" class="search-input">
              <mat-label>{{ searchByComicVineId ? 'Comic Vine ID' : 'Search Term' }}</mat-label>
              <input matInput
                [(ngModel)]="customSearchTerm"
                [ngModelOptions]="{standalone: true}"
                (keyup.enter)="searchComicVine()">
              <mat-hint>{{ searchByComicVineId ? 'Enter a Comic Vine series ID' : 'Search Comic Vine for series to add' }}</mat-hint>
            </mat-form-field>

            <mat-checkbox [(ngModel)]="searchByComicVineId"
              [ngModelOptions]="{standalone: true}"
              class="search-mode-toggle">
              Search by Comic Vine ID
            </mat-checkbox>

            <button type="button"
              mat-stroked-button
              color="primary"
              (click)="searchComicVine()"
              [disabled]="!customSearchTerm || customSearchTerm.length < 3 || searchingComicVine"
              class="search-button">
              <mat-icon>search</mat-icon>
              {{ isComicVineManagementMode ? 'Search for Additional Series' : 'Search Comic Vine' }}
            </button>

            @if (searchingComicVine) {
              <mat-spinner diameter="20"></mat-spinner>
            }
          </div>

          @if (isEditMode && existingComicVineData.length > 0 && !isComicVineManagementMode) {
            <div class="append-mode-control">
              <mat-slide-toggle formControlName="appendMode" (change)="toggleAppendMode()" class="append-toggle">
                {{ getAppendModeLabel() }}
              </mat-slide-toggle>
              <p class="mode-description">{{ getOperationModeMessage() }}</p>
            </div>
          }
        </div>

        <!-- Comic Vine Results -->
        @if (comicVineResults.length > 0) {
          <div class="comic-vine-results">
            <h4>{{ isComicVineManagementMode ? 'Available Series to Add' : 'Comic Vine Results' }} ({{ comicVineResults.length }}):</h4>
            <div class="results-grid">
              @for (result of comicVineResults; track result) {
                <mat-card class="result-card"
                  [class.selected]="isSeriesSelected(result)"
                  (click)="toggleSeriesSelection(result)">
                  <mat-checkbox
                    [checked]="isSeriesSelected(result)"
                    (click)="$event.stopPropagation()"
                    (change)="toggleSeriesSelection(result)">
                  </mat-checkbox>
                  @if (result.imageUrl) {
                    <img [src]="result.imageUrl" [alt]="result.name"
                      class="result-image">
                  }
                  <div class="result-info">
                    <h5>{{ result.name }}</h5>
                    <p>{{ result.publisher }}</p>
                    @if (result.startYear) {
                      <span>{{ result.startYear }}</span>
                    }
                    @if (result.issueCount) {
                      <span class="issue-count">
                        ({{ result.issueCount }} issues)
                      </span>
                    }
                  </div>
                </mat-card>
              }
            </div>
            @if (selectedSeries.length > 0) {
              <div class="selected-series-actions">
                <button type="button" mat-raised-button color="accent" (click)="combineSelectedSeries()">
                  @if (!isComicVineManagementMode) {
                    <span>
                      {{ selectedSeries.length === 1 ? 'Add' : 'Combine' }} {{ selectedSeries.length }} Selected Series
                    </span>
                  }
                  @if (isComicVineManagementMode) {
                    <span>
                      {{ (existingComicVineData.length + selectedSeries.length) >= 2 ? 'Configure & Add' : 'Add' }} {{ selectedSeries.length }} Selected Series
                    </span>
                  }
                </button>
                <button type="button" mat-button (click)="clearSelection()">
                  Clear Selection
                </button>
                <!-- Configuration hint -->
                @if (isComicVineManagementMode && (existingComicVineData.length + selectedSeries.length) >= 2) {
                  <div class="config-hint">
                    <mat-icon>info</mat-icon>
                    <span>Configuration options will be shown for {{ existingComicVineData.length + selectedSeries.length }} total series</span>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- No results message -->
        @if (comicVineResults.length === 0 && !searchingComicVine && hasSearched) {
          <div class="no-results">
            <mat-icon>search_off</mat-icon>
            <h4>No Results Found</h4>
            <p>No Comic Vine series found for "{{ customSearchTerm }}". Try a different search term.</p>
          </div>
        }

        <!-- Series Combination Configuration -->
        @if (selectedSeries.length > 0 && showCombinationConfig) {
          <div class="combination-config">
            <mat-card class="config-card">
              <mat-card-header>
                <mat-card-title>
                  {{ isComicVineManagementMode ? 'Configure Added Series' : 'Configure Combined Series' }}
                </mat-card-title>
                @if (isComicVineManagementMode) {
                  <mat-card-subtitle>
                    Choose how to integrate the selected series with your existing collection
                  </mat-card-subtitle>
                }
              </mat-card-header>
              <mat-card-content>
                <!-- Cover Selection -->
                <div class="cover-selection">
                  <h4>Choose Cover Image:</h4>
                  <div class="cover-options">
                    @for (series of allAvailableSeries; track series) {
                      <div class="cover-option"
                        [class.selected]="selectedCover === series.imageUrl"
                        [class.existing]="isExistingSeries(series.id)"
                        (click)="selectCover(series.imageUrl!)">
                        <img [src]="series.imageUrl" [alt]="series.name" class="cover-thumbnail">
                        <span>{{ series.name }}</span>
                        @if (isExistingSeries(series.id)) {
                          <div class="series-badge">Current</div>
                        }
                        @if (!isExistingSeries(series.id)) {
                          <div class="series-badge new">New</div>
                        }
                      </div>
                    }
                  </div>
                </div>
                <!-- Details Selection -->
                <div class="details-selection">
                  <h4>Choose Primary Details From:</h4>
                  <div class="primary-series-form">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Primary Series</mat-label>
                      <mat-select formControlName="selectedPrimarySeries">
                        @for (series of allAvailableSeries; track series) {
                          <mat-option [value]="series">
                            <div class="series-option-content">
                              <div class="series-main-info">
                                <strong>{{ series.name }}</strong>
                                <span class="series-meta">{{ series.publisher }} ({{ series.startYear }})</span>
                                <span class="series-status" [class.existing]="isExistingSeries(series.id)" [class.new]="!isExistingSeries(series.id)">
                                  {{ isExistingSeries(series.id) ? 'Current Series' : 'New Addition' }}
                                </span>
                              </div>
                              @if (series.description) {
                                <div class="series-description">
                                  {{ series.description | slice:0:100 }}{{ series.description.length > 100 ? '...' : '' }}
                                </div>
                              }
                            </div>
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>
                </div>
                <!-- Current Series Info (Management Mode Only) -->
                @if (isComicVineManagementMode) {
                  <div class="current-series-preview">
                    <h4>Current Series Info:</h4>
                    <div class="current-info-card">
                      <div class="current-details">
                        <strong>{{ seriesForm.get('name')?.value }}</strong>
                        <p>{{ seriesForm.get('publisher')?.value }} ({{ seriesForm.get('startYear')?.value }})</p>
                        @if (seriesForm.get('description')?.value) {
                          <p class="current-description">
                            {{ seriesForm.get('description')?.value | slice:0:150 }}{{ seriesForm.get('description')?.value?.length > 150 ? '...' : '' }}
                          </p>
                        }
                        <div class="issue-info">
                          <p>Available: {{ getCurrentAvailableCount() }} issues from {{ existingComicVineData.length }} series</p>
                          <p>Owned: {{ getCurrentOwnedCount() }} issues in collection</p>
                        </div>
                      </div>
                    </div>
                    <div class="metadata-toggle-container">
                      <mat-slide-toggle formControlName="updateMetadataOnAdd" class="metadata-toggle">
                        Update series metadata with primary series details
                      </mat-slide-toggle>
                    </div>
                  </div>
                }
                <!-- Selected Series Summary -->
                <div class="selected-summary">
                  <h4>Selected Series ({{ selectedSeries.length }}):</h4>
                  <mat-chip-set>
                    @for (series of selectedSeries; track series) {
                      <mat-chip
                        [removable]="true"
                        (removed)="removeFromSelection(series)">
                        {{ series.name }} ({{ series.startYear }})
                        <button matChipRemove>
                          <mat-icon>cancel</mat-icon>
                        </button>
                      </mat-chip>
                    }
                  </mat-chip-set>
                </div>
                <!-- Preview of Combined Data -->
                @if (selectedPrimarySeries) {
                  <div class="preview-section">
                    <h4>{{ isComicVineManagementMode ? 'Preview After Adding' : 'Preview Combined Series' }}:</h4>
                    <div class="preview-card">
                      @if (selectedCover) {
                        <div class="preview-image">
                          <img [src]="selectedCover" [alt]="selectedPrimarySeries.name" class="preview-thumbnail">
                        </div>
                      }
                      <div class="preview-details">
                        <strong>{{ isComicVineManagementMode && !updateMetadataOnAdd ? seriesForm.get('name')?.value : selectedPrimarySeries.name }}</strong>
                        <p>{{ isComicVineManagementMode && !updateMetadataOnAdd ? seriesForm.get('publisher')?.value : selectedPrimarySeries.publisher }} â€¢ {{ getPreviewDateRange() }}</p>
                        @if (getPreviewDescription()) {
                          <p class="preview-description">
                            {{ getPreviewDescription() | slice:0:150 }}{{ getPreviewDescription().length > 150 ? '...' : '' }}
                          </p>
                        }
                        <div class="preview-issues">
                          <p>Total available: {{ getPreviewAvailableCount() }} issues from {{ getPreviewSeriesCount() }} series</p>
                          @if (isComicVineManagementMode) {
                            <p>Owned: {{ getCurrentOwnedCount() }} issues in collection</p>
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                }
                <div class="config-actions">
                  <button type="button" mat-raised-button color="primary"
                    (click)="applyCombinedConfiguration()"
                    [disabled]="!selectedPrimarySeries || !selectedCover">
                    {{ isComicVineManagementMode ? 'Add to Collection' : 'Apply Configuration' }}
                  </button>
                  <button type="button" mat-button (click)="cancelCombination()">
                    Cancel
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        }

        <!-- Combined Series IDs Display -->
        @if (seriesForm.get('comicVineIds')?.value?.length > 0) {
          <div class="combined-series-info">
            <h4>{{ isComicVineManagementMode ? 'Associated' : 'Combined' }} Series IDs:</h4>
            <mat-chip-set>
              @for (id of seriesForm.get('comicVineIds')?.value; track id) {
                <mat-chip>
                  {{ id }}
                </mat-chip>
              }
            </mat-chip-set>
          </div>
        }

        <!-- Image preview -->
        @if (seriesForm.get('imageUrl')?.value) {
          <div class="image-preview">
            <h4>Image Preview:</h4>
            <img [src]="seriesForm.get('imageUrl')?.value" [alt]="seriesForm.get('name')?.value"
              class="preview-image"
              onerror="if(this.src!=='assets/placeholder-comic.jpg'){this.src='assets/placeholder-comic.jpg'; this.style.display='block'} else {this.style.display='none'}">
            </div>
          }

        <mat-card-actions align="end">
          <button mat-button type="button" (click)="cancel()">Cancel</button>
          <button mat-raised-button color="primary" type="submit"
            [disabled]="!seriesForm.valid || loading || (isComicVineManagementMode && !hasChanges())">
            @if (loading) {
              <mat-spinner diameter="20"></mat-spinner>
            }
            {{ isComicVineManagementMode ? 'Save Changes' : (isEditMode ? 'Update' : 'Create') }} {{ isComicVineManagementMode ? '' : 'Series' }}
          </button>
        </mat-card-actions>
      </form>
    </mat-card-content>

  </mat-card>

</div>