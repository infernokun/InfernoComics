<div class="stats-page">

  <!-- Loading State -->
  @if (loading) {
    <div class="page-header">
      <ngx-skeleton-loader [theme]="{ width: '200px', height: '32px' }"></ngx-skeleton-loader>
    </div>

    <div class="overview-grid">
      @for (i of [1, 2, 3, 4, 5, 6]; track i) {
        <div class="overview-card skeleton-card">
          <ngx-skeleton-loader [theme]="{ width: '40px', height: '40px', borderRadius: '50%', marginBottom: '12px' }"></ngx-skeleton-loader>
          <ngx-skeleton-loader [theme]="{ width: '60px', height: '28px', marginBottom: '6px' }"></ngx-skeleton-loader>
          <ngx-skeleton-loader [theme]="{ width: '80px', height: '14px' }"></ngx-skeleton-loader>
        </div>
      }
    </div>

    <div class="charts-grid">
      @for (i of [1, 2, 3, 4]; track i) {
        <div class="chart-card skeleton-card">
          <ngx-skeleton-loader [theme]="{ width: '150px', height: '20px', marginBottom: '16px' }"></ngx-skeleton-loader>
          <ngx-skeleton-loader [theme]="{ width: '100%', height: '200px', borderRadius: '8px' }"></ngx-skeleton-loader>
        </div>
      }
    </div>
  }

  <!-- Loaded State -->
  @if (!loading && stats) {
    <!-- Page Header -->
    <div class="page-header" [@fadeInUp]>
      <div class="header-content">
        <h1>
          <mat-icon>insights</mat-icon>
          Collection Stats
        </h1>
        <button mat-icon-button (click)="refresh()" class="refresh-btn" aria-label="Refresh stats">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>

    <!-- Overview Cards -->
    <div class="overview-grid" [@staggerCards]>
      <div class="overview-card card-primary" [@slideInUp]>
        <div class="card-icon">
          <mat-icon>library_books</mat-icon>
        </div>
        <div class="card-value">{{ stats.overview.totalSeries }}</div>
        <div class="card-label">Total Series</div>
      </div>

      <div class="overview-card card-secondary" [@slideInUp]>
        <div class="card-icon">
          <mat-icon>auto_stories</mat-icon>
        </div>
        <div class="card-value">{{ stats.overview.totalIssues }}</div>
        <div class="card-label">Total Issues</div>
      </div>

      <div class="overview-card card-accent" [@slideInUp]>
        <div class="card-icon">
          <mat-icon>business</mat-icon>
        </div>
        <div class="card-value">{{ stats.overview.uniquePublishers }}</div>
        <div class="card-label">Publishers</div>
      </div>

      <div class="overview-card card-info" [@slideInUp]>
        <div class="card-icon">
          <mat-icon>verified</mat-icon>
        </div>
        <div class="card-value">{{ stats.completionStats.completedSeries }}</div>
        <div class="card-label">Complete Series</div>
      </div>

      <div class="overview-card card-warning" [@slideInUp]>
        <div class="card-icon">
          <mat-icon>style</mat-icon>
        </div>
        <div class="card-value">{{ stats.overview.variantIssues }}</div>
        <div class="card-label">Variants</div>
      </div>

      <div class="overview-card card-danger" [@slideInUp]>
        <div class="card-icon">
          <mat-icon>search_off</mat-icon>
        </div>
        <div class="card-value">{{ stats.overview.missingIssues }}</div>
        <div class="card-label">Missing Issues</div>
      </div>
    </div>

    <!-- Charts Grid Row 1 -->
    <div class="charts-grid">

      <!-- Publisher Distribution -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>pie_chart</mat-icon>
            Publisher Distribution
          </h2>
        </div>
        @if (publisherChartOptions) {
          <apx-chart
            [series]="publisherChartOptions.series!"
            [chart]="publisherChartOptions.chart!"
            [labels]="publisherChartOptions.labels!"
            [colors]="publisherChartOptions.colors!"
            [plotOptions]="publisherChartOptions.plotOptions!"
            [dataLabels]="publisherChartOptions.dataLabels!"
            [legend]="publisherChartOptions.legend!"
            [responsive]="publisherChartOptions.responsive!"
          ></apx-chart>
        }
      </div>

      <!-- Collection Health -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>health_and_safety</mat-icon>
            Collection Health
          </h2>
        </div>
        <div class="health-stats-container">
          @if (healthGaugeOptions) {
            <div class="health-gauge">
              <apx-chart
                [series]="healthGaugeOptions.series!"
                [chart]="healthGaugeOptions.chart!"
                [labels]="healthGaugeOptions.labels!"
                [colors]="healthGaugeOptions.colors!"
                [plotOptions]="healthGaugeOptions.plotOptions!"
              ></apx-chart>
            </div>
          }
          <div class="health-metrics">
            <div class="health-metric">
              <mat-icon>functions</mat-icon>
              <div class="health-metric-info">
                <span class="health-metric-value">{{ getAverageIssuesPerSeries() }}</span>
                <span class="health-metric-label">Avg Issues/Series</span>
              </div>
            </div>
            <div class="health-metric">
              <mat-icon>check_circle</mat-icon>
              <div class="health-metric-info">
                <span class="health-metric-value">{{ stats.completionStats.completedSeries }}</span>
                <span class="health-metric-label">Complete Series</span>
              </div>
            </div>
            <div class="health-metric">
              <mat-icon>track_changes</mat-icon>
              <div class="health-metric-info">
                <span class="health-metric-value">{{ stats.completionStats.totalTrackedSeries }}</span>
                <span class="health-metric-label">Tracked Series</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Series by Era -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>calendar_month</mat-icon>
            Series by Era
          </h2>
        </div>
        @if (eraChartOptions) {
          <apx-chart
            [series]="eraChartOptions.series!"
            [chart]="eraChartOptions.chart!"
            [xaxis]="eraChartOptions.xaxis!"
            [yaxis]="eraChartOptions.yaxis!"
            [colors]="eraChartOptions.colors!"
            [plotOptions]="eraChartOptions.plotOptions!"
            [dataLabels]="eraChartOptions.dataLabels!"
            [grid]="eraChartOptions.grid!"
            [tooltip]="eraChartOptions.tooltip!"
          ></apx-chart>
        }
      </div>

      <!-- Read Status -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>menu_book</mat-icon>
            Read Status
          </h2>
        </div>
        @if (readStatusChartOptions) {
          <apx-chart
            [series]="readStatusChartOptions.series!"
            [chart]="readStatusChartOptions.chart!"
            [labels]="readStatusChartOptions.labels!"
            [colors]="readStatusChartOptions.colors!"
            [plotOptions]="readStatusChartOptions.plotOptions!"
            [dataLabels]="readStatusChartOptions.dataLabels!"
            [legend]="readStatusChartOptions.legend!"
            [responsive]="readStatusChartOptions.responsive!"
          ></apx-chart>
        }
      </div>

      <!-- Issue Types -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>category</mat-icon>
            Issue Types
          </h2>
        </div>
        @if (issueTypesChartOptions) {
          <apx-chart
            [series]="issueTypesChartOptions.series!"
            [chart]="issueTypesChartOptions.chart!"
            [labels]="issueTypesChartOptions.labels!"
            [colors]="issueTypesChartOptions.colors!"
            [plotOptions]="issueTypesChartOptions.plotOptions!"
            [dataLabels]="issueTypesChartOptions.dataLabels!"
            [legend]="issueTypesChartOptions.legend!"
            [responsive]="issueTypesChartOptions.responsive!"
          ></apx-chart>
        }
      </div>

      <!-- Issues by Publisher -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>bar_chart</mat-icon>
            Issues by Publisher
          </h2>
        </div>
        @if (issuesByPublisherOptions) {
          <apx-chart
            [series]="issuesByPublisherOptions.series!"
            [chart]="issuesByPublisherOptions.chart!"
            [xaxis]="issuesByPublisherOptions.xaxis!"
            [yaxis]="issuesByPublisherOptions.yaxis!"
            [colors]="issuesByPublisherOptions.colors!"
            [plotOptions]="issuesByPublisherOptions.plotOptions!"
            [dataLabels]="issuesByPublisherOptions.dataLabels!"
            [grid]="issuesByPublisherOptions.grid!"
            [tooltip]="issuesByPublisherOptions.tooltip!"
          ></apx-chart>
        }
      </div>
    </div>

    <!-- Collection Growth -->
    @if (growthChartOptions && (stats.collectionGrowth.length) > 1) {
      <div class="chart-card full-width" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>show_chart</mat-icon>
            Collection Growth
          </h2>
          <span class="chart-subtitle">Issues added per month</span>
        </div>
        <apx-chart
          [series]="growthChartOptions.series!"
          [chart]="growthChartOptions.chart!"
          [xaxis]="growthChartOptions.xaxis!"
          [yaxis]="growthChartOptions.yaxis!"
          [colors]="growthChartOptions.colors!"
          [fill]="growthChartOptions.fill!"
          [stroke]="growthChartOptions.stroke!"
          [dataLabels]="growthChartOptions.dataLabels!"
          [grid]="growthChartOptions.grid!"
          [tooltip]="growthChartOptions.tooltip!"
        ></apx-chart>
      </div>
    }

    <!-- Top Series + Completion -->
    <div class="charts-grid two-col">

      <!-- Top Series by Issue Count -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>leaderboard</mat-icon>
            Top Series by Issues
          </h2>
        </div>
        @if (topSeriesChartOptions) {
          <apx-chart
            [series]="topSeriesChartOptions.series!"
            [chart]="topSeriesChartOptions.chart!"
            [xaxis]="topSeriesChartOptions.xaxis!"
            [yaxis]="topSeriesChartOptions.yaxis!"
            [colors]="topSeriesChartOptions.colors!"
            [plotOptions]="topSeriesChartOptions.plotOptions!"
            [dataLabels]="topSeriesChartOptions.dataLabels!"
            [grid]="topSeriesChartOptions.grid!"
            [tooltip]="topSeriesChartOptions.tooltip!"
          ></apx-chart>
        }
      </div>

      <!-- Series Completion -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>task_alt</mat-icon>
            Series Completion
          </h2>
          <div class="completion-summary">
            <span class="completion-badge">
              {{ stats.completionStats.completedSeries }} / {{ stats.completionStats.totalTrackedSeries }} Complete
            </span>
          </div>
        </div>
        @if (completionChartOptions) {
          <apx-chart
            [series]="completionChartOptions.series!"
            [chart]="completionChartOptions.chart!"
            [xaxis]="completionChartOptions.xaxis!"
            [yaxis]="completionChartOptions.yaxis!"
            [colors]="completionChartOptions.colors!"
            [plotOptions]="completionChartOptions.plotOptions!"
            [dataLabels]="completionChartOptions.dataLabels!"
            [grid]="completionChartOptions.grid!"
            [tooltip]="completionChartOptions.tooltip!"
          ></apx-chart>
        }
      </div>
    </div>

    <!-- Newest Series & Issues -->
    <div class="charts-grid two-col">

      <!-- Newest Series -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>new_releases</mat-icon>
            Newest Series
          </h2>
        </div>
        <div class="newest-list">
          @for (series of getNewestSeries(); track series.id) {
            <a class="newest-item" [routerLink]="getSeriesLink(series)">
              <div class="newest-image">
                @if (series.imageUrl) {
                  <img [src]="series.imageUrl" [alt]="series.name" loading="lazy" />
                } @else {
                  <div class="newest-placeholder">
                    <mat-icon>library_books</mat-icon>
                  </div>
                }
              </div>
              <div class="newest-info">
                <span class="newest-name">{{ series.name }}</span>
                <span class="newest-meta">
                  {{ series.publisher }}
                  @if (series.startYear) {
                    <span class="dot-separator"></span> {{ series.startYear }}
                  }
                </span>
                <span class="newest-stats">
                  {{ series.issuesOwnedCount }} / {{ series.issuesAvailableCount }} issues
                </span>
              </div>
              <span class="newest-time">{{ getRelativeTime(series.createdAt) }}</span>
            </a>
          }
        </div>
      </div>

      <!-- Newest Issues -->
      <div class="chart-card" [@fadeInUp]>
        <div class="chart-header">
          <h2>
            <mat-icon>fiber_new</mat-icon>
            Newest Issues
          </h2>
        </div>
        <div class="newest-list">
          @for (issue of getNewestIssues(); track issue.id) {
            <div class="newest-item">
              <div class="newest-image">
                @if (issue.imageUrl) {
                  <img [src]="issue.imageUrl" [alt]="issue.seriesName + ' #' + issue.issueNumber" loading="lazy" />
                } @else {
                  <div class="newest-placeholder">
                    <mat-icon>auto_stories</mat-icon>
                  </div>
                }
              </div>
              <div class="newest-info">
                <span class="newest-name">{{ issue.seriesName }}</span>
                <span class="newest-meta">
                  {{ issue.title ? issue.title : '#' + issue.issueNumber }}
                </span>
              </div>
              <span class="newest-time">{{ getRelativeTime(issue.createdAt) }}</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Processing & Sync Stats Section -->
    @if (stats.processingStats || stats.fileStats || stats.syncStats) {
      <div class="section-divider">
        <h2 class="section-title">
          <mat-icon>memory</mat-icon>
          Processing & Sync Statistics
        </h2>
      </div>

      <!-- Processing Overview Cards -->
      <div class="overview-grid" [@staggerCards]>
        <div class="overview-card card-primary" [@slideInUp]>
          <div class="card-icon">
            <mat-icon>sync</mat-icon>
          </div>
          <div class="card-value">{{ stats.processingStats.totalSessions }}</div>
          <div class="card-label">Processing Sessions</div>
        </div>

        <div class="overview-card card-secondary" [@slideInUp]>
          <div class="card-icon">
            <mat-icon>insert_drive_file</mat-icon>
          </div>
          <div class="card-value">{{ stats.fileStats.totalFiles }}</div>
          <div class="card-label">Files Processed</div>
        </div>

        <div class="overview-card card-accent" [@slideInUp]>
          <div class="card-icon">
            <mat-icon>cloud_sync</mat-icon>
          </div>
          <div class="card-value">{{ stats.syncStats.totalSyncs }}</div>
          <div class="card-label">Sync Operations</div>
        </div>

        <div class="overview-card card-info" [@slideInUp]>
          <div class="card-icon">
            <mat-icon>timer</mat-icon>
          </div>
          <div class="card-value">{{ stats.processingStats.avgDurationFormatted }}</div>
          <div class="card-label">Avg Duration</div>
        </div>

        <div class="overview-card card-warning" [@slideInUp]>
          <div class="card-icon">
            <mat-icon>storage</mat-icon>
          </div>
          <div class="card-value">{{ stats.fileStats.totalFileSizeFormatted }}</div>
          <div class="card-label">Total File Size</div>
        </div>

        <div class="overview-card card-danger" [@slideInUp]>
          <div class="card-icon">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="card-value">{{ stats.syncStats.syncsNeedingAttentionCount }}</div>
          <div class="card-label">Needs Attention</div>
        </div>
      </div>

      <!-- Processing Charts -->
      <div class="charts-grid">

        <!-- Processing Session States -->
        <div class="chart-card" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>donut_large</mat-icon>
              Session States
            </h2>
          </div>
          @if (processingStateChartOptions.series?.length) {
            <apx-chart
              [series]="processingStateChartOptions.series!"
              [chart]="processingStateChartOptions.chart!"
              [labels]="processingStateChartOptions.labels!"
              [colors]="processingStateChartOptions.colors!"
              [plotOptions]="processingStateChartOptions.plotOptions!"
              [dataLabels]="processingStateChartOptions.dataLabels!"
              [legend]="processingStateChartOptions.legend!"
              [responsive]="processingStateChartOptions.responsive!"
            ></apx-chart>
          } @else {
            <div class="no-data">
              <mat-icon>info</mat-icon>
              <span>No processing data yet</span>
            </div>
          }
        </div>

        <!-- Processing Success Rate -->
        <div class="chart-card" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>speed</mat-icon>
              Processing Success
            </h2>
          </div>
          <div class="health-stats-container">
            @if (processingSuccessGaugeOptions) {
              <div class="health-gauge">
                <apx-chart
                  [series]="processingSuccessGaugeOptions.series!"
                  [chart]="processingSuccessGaugeOptions.chart!"
                  [labels]="processingSuccessGaugeOptions.labels!"
                  [colors]="processingSuccessGaugeOptions.colors!"
                  [plotOptions]="processingSuccessGaugeOptions.plotOptions!"
                ></apx-chart>
              </div>
            }
            <div class="health-metrics">
              <div class="health-metric">
                <mat-icon>check_circle</mat-icon>
                <div class="health-metric-info">
                  <span class="health-metric-value">{{ stats.processingStats.successfulSessions }}</span>
                  <span class="health-metric-label">Successful</span>
                </div>
              </div>
              <div class="health-metric">
                <mat-icon>error</mat-icon>
                <div class="health-metric-info">
                  <span class="health-metric-value">{{ stats.processingStats.failedSessions }}</span>
                  <span class="health-metric-label">Failed</span>
                </div>
              </div>
              <div class="health-metric">
                <mat-icon>inventory_2</mat-icon>
                <div class="health-metric-info">
                  <span class="health-metric-value">{{ stats.processingStats.totalItemsProcessed }}</span>
                  <span class="health-metric-label">Items Processed</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Manual vs Auto -->
        <div class="chart-card" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>touch_app</mat-icon>
              Started By
            </h2>
          </div>
          @if (startedByChartOptions.series?.length) {
            <apx-chart
              [series]="startedByChartOptions.series!"
              [chart]="startedByChartOptions.chart!"
              [labels]="startedByChartOptions.labels!"
              [colors]="startedByChartOptions.colors!"
              [plotOptions]="startedByChartOptions.plotOptions!"
              [dataLabels]="startedByChartOptions.dataLabels!"
              [legend]="startedByChartOptions.legend!"
              [responsive]="startedByChartOptions.responsive!"
            ></apx-chart>
          } @else {
            <div class="no-data">
              <mat-icon>info</mat-icon>
              <span>No data available</span>
            </div>
          }
        </div>

        <!-- File States -->
        <div class="chart-card" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>folder</mat-icon>
              File Processing Status
            </h2>
          </div>
          @if (fileStateChartOptions.series?.length) {
            <apx-chart
              [series]="fileStateChartOptions.series!"
              [chart]="fileStateChartOptions.chart!"
              [labels]="fileStateChartOptions.labels!"
              [colors]="fileStateChartOptions.colors!"
              [plotOptions]="fileStateChartOptions.plotOptions!"
              [dataLabels]="fileStateChartOptions.dataLabels!"
              [legend]="fileStateChartOptions.legend!"
              [responsive]="fileStateChartOptions.responsive!"
            ></apx-chart>
          } @else {
            <div class="no-data">
              <mat-icon>info</mat-icon>
              <span>No file data yet</span>
            </div>
          }
        </div>

        <!-- Sync Status Distribution -->
        <div class="chart-card" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>sync_alt</mat-icon>
              Sync Status
            </h2>
          </div>
          @if (syncStatusChartOptions.series?.length) {
            <apx-chart
              [series]="syncStatusChartOptions.series!"
              [chart]="syncStatusChartOptions.chart!"
              [labels]="syncStatusChartOptions.labels!"
              [colors]="syncStatusChartOptions.colors!"
              [plotOptions]="syncStatusChartOptions.plotOptions!"
              [dataLabels]="syncStatusChartOptions.dataLabels!"
              [legend]="syncStatusChartOptions.legend!"
              [responsive]="syncStatusChartOptions.responsive!"
            ></apx-chart>
          } @else {
            <div class="no-data">
              <mat-icon>info</mat-icon>
              <span>No sync data yet</span>
            </div>
          }
        </div>

        <!-- Sync Health -->
        <div class="chart-card" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>monitor_heart</mat-icon>
              Sync Health
            </h2>
          </div>
          <div class="health-stats-container">
            @if (syncHealthGaugeOptions) {
              <div class="health-gauge">
                <apx-chart
                  [series]="syncHealthGaugeOptions.series!"
                  [chart]="syncHealthGaugeOptions.chart!"
                  [labels]="syncHealthGaugeOptions.labels!"
                  [colors]="syncHealthGaugeOptions.colors!"
                  [plotOptions]="syncHealthGaugeOptions.plotOptions!"
                ></apx-chart>
              </div>
            }
            <div class="health-metrics">
              <div class="health-metric">
                <mat-icon>folder_copy</mat-icon>
                <div class="health-metric-info">
                  <span class="health-metric-value">{{ stats.syncStats.uniqueSeriesSynced }}</span>
                  <span class="health-metric-label">Series Synced</span>
                </div>
              </div>
              <div class="health-metric">
                <mat-icon>description</mat-icon>
                <div class="health-metric-info">
                  <span class="health-metric-value">{{ stats.syncStats.totalFilesTracked }}</span>
                  <span class="health-metric-label">Files Tracked</span>
                </div>
              </div>
              <div class="health-metric">
                <mat-icon>functions</mat-icon>
                <div class="health-metric-info">
                  <span class="health-metric-value">{{ stats.syncStats.avgFilesPerSync }}</span>
                  <span class="health-metric-label">Avg Files/Sync</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Processing Activity by Day -->
      @if (processingByDayChartOptions.series) {
        <div class="chart-card full-width" [@fadeInUp]>
          <div class="chart-header">
            <h2>
              <mat-icon>calendar_view_week</mat-icon>
              Processing Activity by Day
            </h2>
          </div>
          <apx-chart
            [series]="processingByDayChartOptions.series!"
            [chart]="processingByDayChartOptions.chart!"
            [xaxis]="processingByDayChartOptions.xaxis!"
            [yaxis]="processingByDayChartOptions.yaxis!"
            [colors]="processingByDayChartOptions.colors!"
            [plotOptions]="processingByDayChartOptions.plotOptions!"
            [dataLabels]="processingByDayChartOptions.dataLabels!"
            [grid]="processingByDayChartOptions.grid!"
            [tooltip]="processingByDayChartOptions.tooltip!"
          ></apx-chart>
        </div>
      }
    }

  }

  <!-- Empty State -->
  @if (!loading && !stats) {
    <div class="empty-state">
      <mat-icon>analytics</mat-icon>
      <h3>No Stats Available</h3>
      <p>Add some series and issues to see collection statistics.</p>
    </div>
  }
</div>
