{% extends "base.html" %}

{% block title %}Comic Series Evaluation - Inferno Comics{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/evaluation.css') }}">
{% endblock %}

{% block header %}
<header class="page-header animate-fade-in-down">
    <h1>Comic Series Evaluation</h1>
    <p>Analyze and match your comic images in real-time</p>
    <nav class="nav-buttons">
        <a href="#" class="btn btn-secondary" id="viewAllResultsBtn">View All Results</a>
        <a href="#" class="btn btn-ghost" onclick="window.location.reload()">New Evaluation</a>
    </nav>
</header>
{% endblock %}

{% block content %}
<!-- Evaluation Form -->
<div class="card animate-fade-in-up" id="evaluationCard">
    <div class="card-header">
        <h2 class="card-title">Start New Evaluation</h2>
    </div>
    <form id="evaluationForm">
        <div class="grid grid-cols-2 gap-md">
            <div class="form-group">
                <label class="form-label" for="folderInput">Series Folder Name</label>
                <input type="text" class="form-input" id="folderInput" name="folder"
                       placeholder="e.g., Green Lanterns (2016)" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="idInput">Series ID</label>
                <input type="number" class="form-input" id="idInput" name="seriesId"
                       placeholder="Enter series ID" required>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg" id="startBtn">
                <span class="spinner hidden" id="loadingSpinner"></span>
                Start Evaluation
            </button>
            <button type="button" class="btn btn-danger hidden" id="stopBtn">
                Stop Evaluation
            </button>
        </div>
    </form>
</div>

<!-- Progress Section -->
<div class="card hidden" id="progressCard">
    <div class="flex justify-between items-center mb-md">
        <h3>Evaluation Progress</h3>
        <div class="progress-stats-bar" id="progressStats">
            <span class="progress-stat success" id="successCount">0</span>
            <span class="progress-stat warning" id="warningCount">0</span>
            <span class="progress-stat error" id="errorCount">0</span>
        </div>
    </div>

    <div class="progress-container mb-md">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>

    <div class="flex justify-between items-center text-muted">
        <span id="progressText">0%</span>
        <div class="session-display hidden" id="sessionIdDisplay">
            Session: <span id="sessionIdValue"></span>
        </div>
    </div>
</div>

<!-- Current Processing -->
<div class="processing-card hidden" id="currentProcessing">
    <div class="processing-header">
        <div class="processing-icon">
            <div class="spinner"></div>
        </div>
        <div>
            <div class="processing-title">Currently Processing</div>
            <div class="processing-subtitle" id="currentImageProgress">Preparing...</div>
        </div>
    </div>

    <div class="current-image-container">
        <img class="current-image-preview" id="currentImagePreview"
             src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDEyMCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjMjQyNDMyIi8+Cjx0ZXh0IHg9IjYwIiB5PSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzcwNzA4MCIgZm9udC1zaXplPSIxMiI+TG9hZGluZy4uLjwvdGV4dD4KPC9zdmc+"
             alt="Current processing image">
        <div class="current-image-info">
            <div class="current-image-name" id="currentImageName">Preparing...</div>
            <div class="current-image-status" id="currentImageStatus">
                <span class="spinner"></span>
                Getting ready to start evaluation
            </div>
        </div>
    </div>
</div>

<!-- Detailed Results -->
<div class="results-container hidden" id="detailedResults">
    <div class="results-header">
        <h3>Results</h3>
        <span class="text-muted" id="resultsCount">0 processed</span>
    </div>
    <div id="detailedResultsContent">
        <div class="empty-state">
            <div class="empty-state-icon">Loading...</div>
            <div class="empty-state-title">Waiting for results...</div>
        </div>
    </div>
</div>

<!-- Completion Summary -->
<div class="completion-summary hidden" id="completionSummary">
    <div class="completion-icon" id="completionIcon"></div>
    <div class="completion-title" id="completionTitle">Evaluation Complete</div>
    <div class="completion-subtitle" id="completionSubtitle">All images have been processed</div>

    <div class="threshold-banner">
        <span class="threshold-banner-icon">Info</span>
        <span><strong>Similarity Threshold:</strong> 0.25 for successful match</span>
    </div>

    <div class="grid grid-auto-fit gap-md mb-lg" id="detailedStats">
        <div class="stat-card">
            <div class="stat-value info" id="totalImagesDetail">0</div>
            <div class="stat-label">Total Images</div>
        </div>
        <div class="stat-card">
            <div class="stat-value success" id="successfulMatchesDetail">0</div>
            <div class="stat-label">Successful Matches</div>
        </div>
        <div class="stat-card">
            <div class="stat-value warning" id="noMatchesDetail">0</div>
            <div class="stat-label">No Matches</div>
        </div>
        <div class="stat-card">
            <div class="stat-value error" id="apiFailuresDetail">0</div>
            <div class="stat-label">API Failures</div>
        </div>
        <div class="stat-card">
            <div class="stat-value info" id="bestSimilarityDetail">0.000</div>
            <div class="stat-label">Best Similarity</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="overallResultDetail">-</div>
            <div class="stat-label">Overall Result</div>
        </div>
    </div>

    <div class="result-links hidden" id="resultLinkSection">
        <a href="#" class="btn btn-primary" id="viewResultLink" target="_blank">View Detailed Results</a>
        <a href="#" class="btn btn-secondary" id="downloadResultLink" target="_blank">Download JSON</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let eventSource = null;
    let isEvaluating = false;
    let currentSessionId = null;
    let processedResults = [];
    let stats = { success: 0, warning: 0, error: 0, totalImages: 0, processed: 0 };

    // DOM Elements
    const form = document.getElementById('evaluationForm');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const progressCard = document.getElementById('progressCard');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentProcessing = document.getElementById('currentProcessing');
    const detailedResults = document.getElementById('detailedResults');
    const detailedResultsContent = document.getElementById('detailedResultsContent');
    const completionSummary = document.getElementById('completionSummary');

    form.addEventListener('submit', startEvaluation);
    stopBtn.addEventListener('click', stopEvaluation);

    function startEvaluation(e) {
        e.preventDefault();
        if (isEvaluating) return;

        const folder = document.getElementById('folderInput').value.trim();
        const seriesId = document.getElementById('idInput').value.trim();

        if (!folder) { alert('Please enter a folder name'); return; }
        if (!seriesId || isNaN(seriesId)) { alert('Please enter a valid series ID'); return; }

        isEvaluating = true;
        startBtn.disabled = true;
        loadingSpinner.classList.remove('hidden');
        startBtn.innerHTML = '<span class="spinner"></span> Starting...';
        stopBtn.classList.remove('hidden');

        resetUI();
        UI.show('progressCard');
        UI.show('currentProcessing');
        UI.hide('completionSummary');

        API.post('/evaluation', { folder, seriesId })
            .then(r => r.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                currentSessionId = data.session_id;
                UI.setText('sessionIdValue', currentSessionId);
                UI.show('sessionIdDisplay');
                startProgressListener();
            })
            .catch(error => {
                alert('Error starting evaluation: ' + error.message);
                resetEvaluationState();
            });
    }

    function startProgressListener() {
        if (!currentSessionId) return;
        eventSource = API.eventSource(`/evaluation/progress?session_id=${currentSessionId}`);
        eventSource.onmessage = e => handleProgressUpdate(JSON.parse(e.data));
        eventSource.onerror = () => {
            if (isEvaluating) setTimeout(() => isEvaluating && currentSessionId && startProgressListener(), 1000);
        };
    }

    function handleProgressUpdate(data) {
        switch (data.type) {
            case 'status':
                updateStatus(data.message);
                updateProgress(data.progress);
                if (data.total_images) stats.totalImages = data.total_images;
                break;
            case 'processing':
                updateStatus(data.message);
                updateProgress(data.progress);
                if (data.current_image_url) updateCurrentImage(data.current_image, data.current_image_url, data.processed, data.total_images);
                stats.processed = data.processed;
                stats.totalImages = data.total_images;
                break;
            case 'detailed_result':
                updateProgress(data.progress);
                addDetailedResult(data.detailed_result);
                updateStats(data);
                break;
            case 'complete':
                updateProgress(100);
                showCompletion(data);
                UI.hide('currentProcessing');
                UI.hide('progressCard');
                if (currentSessionId) showResultLinks();
                resetEvaluationState();
                break;
            case 'error':
                alert('Evaluation failed: ' + data.message);
                UI.hide('currentProcessing');
                UI.hide('progressCard');
                resetEvaluationState();
                break;
            case 'stopped':
                UI.hide('currentProcessing');
                UI.hide('progressCard');
                resetEvaluationState();
                break;
        }
    }

    function updateStatus(message) {
        UI.setHtml('currentImageStatus', `<span class="spinner"></span> ${message}`);
    }

    function updateProgress(progress) {
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${Math.round(progress)}%`;
    }

    function updateCurrentImage(name, url, processed, total) {
        UI.setText('currentImageName', name);
        UI.setText('currentImageProgress', `Image ${processed + 1} of ${total}`);
        if (url) {
            const preview = document.getElementById('currentImagePreview');
            preview.src = url;
            preview.onerror = () => preview.src = PLACEHOLDER_IMAGE;
        }
    }

    function updateStats(data) {
        if (data.status === 'success') stats.success++;
        else if (data.status === 'warning') stats.warning++;
        else if (data.status === 'error') stats.error++;

        UI.setText('successCount', stats.success);
        UI.setText('warningCount', stats.warning);
        UI.setText('errorCount', stats.error);
        UI.setText('resultsCount', `${stats.success + stats.warning + stats.error} processed`);
    }

    function addDetailedResult(result) {
        UI.show('detailedResults');
        const container = detailedResultsContent;

        // Clear placeholder on first result
        if (container.querySelector('.empty-state')) container.innerHTML = '';

        const resultClass = result.api_success ? (result.match_success ? 'match-success' : 'no-match') : 'error';
        const badge = !result.api_success ? '<span class="badge badge-error">API Failed</span>' :
                      result.match_success ? '<span class="badge badge-success">Match Found</span>' :
                      '<span class="badge badge-warning">No Match</span>';

        const similarityHtml = result.api_success ?
            `<div class="similarity-highlight ${result.best_similarity >= 0.25 ? 'good' : 'poor'}">
                Best: ${result.best_similarity.toFixed(4)} ${result.best_similarity >= 0.25 ? '(Threshold Met)' : '(Below Threshold)'}
            </div>` : '';

        let matchesHtml = '';
        if (result.api_success && result.matches?.length) {
            matchesHtml = '<div class="match-grid">';
            result.matches.forEach((match, i) => {
                const imgUrl = match.local_url || match.url;
                const scoreColor = match.similarity >= 0.25 ? 'var(--color-success)' :
                                   match.similarity >= 0.10 ? 'var(--color-warning)' : 'var(--color-error)';
                matchesHtml += `
                    <div class="match-card ${match.meets_threshold ? 'threshold-met' : ''}">
                        <img src="${imgUrl}" alt="Match ${i + 1}" onerror="this.src='${PLACEHOLDER_IMAGE}'">
                        <div class="match-score" style="color: ${scoreColor}">${match.similarity.toFixed(4)}</div>
                        <div class="match-status ${match.meets_threshold ? 'success' : ''}">${match.meets_threshold ? 'Match' : 'Below'}</div>
                    </div>`;
            });
            matchesHtml += '</div>';
        }

        const item = UI.create('div', {
            class: `result-item ${resultClass}`,
            html: `
                <div class="result-image-section">
                    <img src="${result.image_url || PLACEHOLDER_IMAGE}" alt="${result.image_name}" class="result-image" onerror="this.src='${PLACEHOLDER_IMAGE}'">
                    <div class="result-image-name">${result.image_name}</div>
                </div>
                <div class="result-content">
                    ${badge}
                    ${similarityHtml}
                    ${result.error ? `<div class="alert alert-error"><span>Error:</span> ${result.error}</div>` : ''}
                    ${matchesHtml || (result.api_success ? '<p class="text-muted">No matches found</p>' : '')}
                </div>`
        });

        container.insertBefore(item, container.firstChild);
        while (container.children.length > 10) container.removeChild(container.lastChild);
    }

    function showCompletion(data) {
        const isSuccess = data.overall_success;
        completionSummary.className = `completion-summary ${isSuccess ? 'success' : 'failure'}`;
        UI.show('completionSummary');

        UI.setText('completionIcon', isSuccess ? 'Success' : 'Failed');
        UI.setText('completionTitle', isSuccess ? 'OVERALL SUCCESS' : 'NO MATCHES FOUND');
        UI.setText('completionSubtitle', isSuccess
            ? `At least one image was successfully matched for ${data.series_name} (${data.year})!`
            : 'No images met the similarity threshold.');

        UI.setText('totalImagesDetail', data.total_images || 0);
        UI.setText('successfulMatchesDetail', data.successful_matches || 0);
        UI.setText('noMatchesDetail', data.no_matches || 0);
        UI.setText('apiFailuresDetail', data.failed_uploads || 0);
        UI.setText('bestSimilarityDetail', (data.best_similarity || 0).toFixed(4));

        const overallEl = document.getElementById('overallResultDetail');
        overallEl.textContent = isSuccess ? 'Success' : 'Failed';
        overallEl.className = `stat-value ${isSuccess ? 'success' : 'error'}`;

        UI.scrollTo('completionSummary');
    }

    function showResultLinks() {
        document.getElementById('viewResultLink').href = API.url(`/evaluation/${currentSessionId}`);
        document.getElementById('downloadResultLink').href = API.url(`/evaluation/${currentSessionId}/data`);
        UI.show('resultLinkSection');
    }

    function stopEvaluation() {
        if (!isEvaluating || !currentSessionId) return;
        API.post('/evaluation/stop', { session_id: currentSessionId });
        resetEvaluationState();
    }

    function resetEvaluationState() {
        isEvaluating = false;
        startBtn.disabled = false;
        startBtn.innerHTML = 'Start Evaluation';
        loadingSpinner.classList.add('hidden');
        stopBtn.classList.add('hidden');
        if (eventSource) { eventSource.close(); eventSource = null; }
    }

    function resetUI() {
        stats = { success: 0, warning: 0, error: 0, totalImages: 0, processed: 0 };
        processedResults = [];
        UI.setText('successCount', '0');
        UI.setText('warningCount', '0');
        UI.setText('errorCount', '0');
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        UI.setText('currentImageName', 'Preparing...');
        UI.setHtml('currentImageStatus', '<span class="spinner"></span> Getting ready...');
        UI.hide('sessionIdDisplay');
        detailedResultsContent.innerHTML = '<div class="empty-state"><div class="empty-state-title">Waiting for results...</div></div>';
    }

    window.addEventListener('beforeunload', () => eventSource?.close());

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('viewAllResultsBtn').href = API.url('/evaluation/list');
    });
</script>
{% endblock %}
