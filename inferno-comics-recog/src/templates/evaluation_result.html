{% extends "base.html" %}

{% block title %}{{ result.series_name }}{% if result.year %} ({{ result.year }}){% endif %} - Inferno Comics{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/evaluation.css') }}">
{% endblock %}

{% block header %}
<header class="page-header animate-fade-in-down">
    <h1>{{ result.series_name }}{% if result.year %} ({{ result.year }}){% endif %}</h1>
    <p>
        Evaluated on {{ result.timestamp }}<br>
        <span class="font-mono text-muted">Session: {{ result.session_id }}</span>
        {% if result.query_type %}
        <span class="badge badge-info mt-sm">{{ result.query_type.replace('_', ' ').title() }}</span>
        {% endif %}
    </p>
    <nav class="nav-buttons">
        <a href="#" class="btn btn-primary" id="newEvaluationBtn">New Evaluation</a>
        <a href="#" class="btn btn-secondary" id="viewAllResultsBtn">View All Results</a>
        <a href="#" class="btn btn-ghost" id="downloadJsonBtn">Download JSON</a>
    </nav>
</header>
{% endblock %}

{% block content %}
<!-- Threshold Info -->
<div class="threshold-banner animate-fade-in">
    <span class="threshold-banner-icon">Info</span>
    <span><strong>Similarity Threshold:</strong> {{ "%.4f"|format(result.similarity_threshold) }} (matches above this are successful)</span>
</div>

<!-- Stats Summary -->
<div class="grid grid-auto-fit gap-md mb-lg animate-fade-in-up">
    <div class="stat-card">
        <div class="stat-value info">{{ result.total_images }}</div>
        <div class="stat-label">Total Images</div>
    </div>
    <div class="stat-card">
        <div class="stat-value success">{{ result.successful_matches }}</div>
        <div class="stat-label">Successful Matches</div>
    </div>
    <div class="stat-card">
        <div class="stat-value warning">{{ result.no_matches }}</div>
        <div class="stat-label">No Matches</div>
    </div>
    <div class="stat-card">
        <div class="stat-value error">{{ result.failed_uploads }}</div>
        <div class="stat-label">Failed Uploads</div>
    </div>
    <div class="stat-card">
        <div class="stat-value info">{{ "%.4f"|format(result.best_similarity) }}</div>
        <div class="stat-label">Best Similarity</div>
    </div>
    {% if result.total_covers_processed %}
    <div class="stat-card">
        <div class="stat-value">{{ result.total_covers_processed }}</div>
        <div class="stat-label">Covers Processed</div>
    </div>
    {% endif %}
</div>

<!-- Detailed Results -->
<div class="card animate-fade-in-up">
    <div class="card-header">
        <h2 class="card-title">Detailed Results</h2>
        <span class="text-muted">{{ result.results|length }} images</span>
    </div>

    <div class="grid grid-auto-fit gap-md">
        {% for item in result.results %}
        <div class="card {% if item.api_success %}{% if item.match_success %}border-success{% else %}border-warning{% endif %}{% else %}border-error{% endif %}" style="border-left: 4px solid {% if item.api_success %}{% if item.match_success %}var(--color-success){% else %}var(--color-warning){% endif %}{% else %}var(--color-error){% endif %};">

            <!-- Image Preview -->
            {% if item.image_url %}
            <img src="{{ item.image_url }}" alt="{{ item.image_name }}" class="result-image mb-md"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                 style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius-sm);">
            <div class="empty-state" style="display: none; height: 200px;">Image not available</div>
            {% elif item.image_base64 %}
            <img src="{{ item.image_base64 }}" alt="{{ item.image_name }}" class="result-image mb-md"
                 style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius-sm);">
            {% else %}
            <div class="empty-state" style="height: 200px;">No image available</div>
            {% endif %}

            <!-- Image Name -->
            <div class="font-bold mb-sm" style="word-break: break-word;">{{ item.image_name }}</div>

            <!-- Status Badge -->
            <div class="mb-md">
                {% if item.api_success %}
                    {% if item.match_success %}
                    <span class="badge badge-success">Match Found</span>
                    {% else %}
                    <span class="badge badge-warning">No Match</span>
                    {% endif %}
                {% else %}
                <span class="badge badge-error">API Failed</span>
                {% endif %}
            </div>

            <!-- Similarity Score -->
            {% if item.api_success %}
            <div class="similarity-highlight {% if item.best_similarity >= result.similarity_threshold %}good{% else %}poor{% endif %} mb-md">
                Best: {{ "%.4f"|format(item.best_similarity) }}
                {% if item.best_similarity >= result.similarity_threshold %}
                <span class="text-success">(Threshold Met)</span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Error Message -->
            {% if item.error %}
            <div class="alert alert-error">
                <span class="alert-icon">Error</span>
                <span>{{ item.error }}</span>
            </div>
            {% endif %}

            <!-- Matches -->
            {% if item.matches %}
            <div class="mt-md">
                <div class="text-muted mb-sm font-bold">Top Matches ({{ item.total_matches }} total)</div>

                <!-- Visual Match Grid -->
                {% set visual_matches = item.matches|selectattr('local_url')|list %}
                {% if visual_matches %}
                <div class="image-grid mb-md">
                    {% for match in visual_matches[:4] %}
                    <div class="image-item {% if match.meets_threshold %}success{% endif %}">
                        <img src="{{ match.local_url }}" alt="Match {{ loop.index }}" onerror="this.style.display='none';">
                        <div class="image-item-overlay">{{ "%.3f"|format(match.similarity) }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Match List -->
                {% for match in item.matches %}
                <div class="flex items-center gap-sm mb-sm" style="padding: 8px; background: var(--color-bg-primary); border-radius: var(--radius-sm); {% if match.meets_threshold %}border-left: 3px solid var(--color-success);{% endif %}">
                    <span class="font-bold" style="min-width: 60px; color: {% if match.similarity >= result.similarity_threshold %}var(--color-success){% elif match.similarity >= 0.10 %}var(--color-warning){% else %}var(--color-error){% endif %};">
                        {{ "%.4f"|format(match.similarity) }}
                    </span>
                    {% if match.url %}
                    <a href="{{ match.url }}" target="_blank" class="text-muted" style="word-break: break-all; font-size: 0.875rem;">
                        {% if match.comic_name and match.issue_number %}
                            {{ match.comic_name }} #{{ match.issue_number }}
                        {% else %}
                            {{ match.url|truncate(50) }}
                        {% endif %}
                    </a>
                    {% else %}
                    <span class="text-muted">No URL</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sessionId = '{{ result.session_id }}';

        {% if result.query_type and 'image' in result.query_type %}
        document.getElementById('newEvaluationBtn').href = API.url('/image-matcher');
        document.getElementById('downloadJsonBtn').href = API.url(`/image-matcher/${sessionId}/data`);
        {% else %}
        document.getElementById('newEvaluationBtn').href = API.url('/evaluation');
        document.getElementById('downloadJsonBtn').href = API.url(`/evaluation/${sessionId}/data`);
        {% endif %}

        document.getElementById('viewAllResultsBtn').href = API.url('/evaluation/list');
    });
</script>
{% endblock %}
